

![image-20220729100757005](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729100757005.png)



![image-20220729103143204](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729103143204.png)

CPU眼里线程是0感知的  看到的都是task_struct

![image-20220729103219065](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729103219065.png)

轻量化：上下文数据不用变了  比起之前的执行 换一个进程 数据，页表和地址空间，甚至缓存数据等等都要换 但是切换线程时这些都不用动

用进程来模拟的

![image-20220729113527762](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729113527762.png)



之前说CPU进行的是进程调度，到现在加一层理解，CPU调度的其实都是线程

![image-20220729113829018](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729113829018.png)



![image-20220729125800585](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729125800585.png)





![image-20220729130325143](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729130325143.png)

![image-20220729130313212](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729130313212.png)

合适：与计算机核数相当

不合适：线程过多 CPU过多的时间花在切换线程上（同步和调度开销



![image-20220729150250511](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729150250511.png)

![image-20220729153722753](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729153722753.png)



#### ![image-20220729150804824](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729150804824.png)



![image-20220729151309339](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729151309339.png)

![image-20220729151321121](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729151321121.png)





![image-20220729151740976](C:/Users/ADMIN/AppData/Roaming/Typora/typora-user-images/image-20220729151740976.png)

![](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729151825406.png)





以前是单执行流 两个相等

![image-20220729152106991](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729152106991.png)





![image-20220729152556070](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729152556070.png)

一个线程出问题导致进程退出 这也是为什么说线程降低了程序的健壮性

![image-20220729153537161](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729153537161.png)



![image-20220729154050200](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729154050200.png)



![image-20220729155046825](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729155046825.png)



![image-20220729154750471](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729154750471.png)



![image-20220729155021524](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729155021524.png)

![image-20220729155622247](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729155622247.png)



![image-20220729161349626](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729161349626.png)



![image-20220729160803246](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729160803246.png)

![image-20220729161623417](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729161623417.png)



其他进程干掉主进程 其他线程一直跑导致进程一直处于Z状态 不被回收 

![image-20220729163136584](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729163136584.png)



![image-20220729163236006](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729163236006.png)



CPU不需要线程的概念   linux下线程这个概念是给用户的  因为用户需要多线程编程

因为不管进程还是线程啊 在linux内核里都是task_struct



linux下进程模拟实现的线程。



线程优点和缺点 斗与共享大量资源有关

进程为什么独立  因为有自己独立的地址空间 页表等。





![image-20220729212914901](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729212914901.png)



防止内存泄漏  （一直占着资源没释放，有点Z状态的意思

让main线程最后退出（main没了还有别的线程在跑不太合理

获得新线程的退出码（任务做的怎么样

  

![image-20220729213353372](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729213353372.png)

 





![image-20220730000452672](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730000452672.png)

![image-20220730000249758](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730000249758.png)





![image-20220730000327168](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730000327168.png)





返回值为void*的解释

![image-20220730194521066](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730194521066.png)



![image-20220730203122270](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730203122270.png)





返回一个结构体

![image-20220730203355531](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730203355531.png)

![image-20220730203415865](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730203415865.png)





![image-20220730204623368](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730204623368.png)



![image-20220730210436658](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730210436658.png)



![image-20220729100757005](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729100757005.png)  ![image-20220729103143204](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729103143204.png) CPU眼里线程是0感知的  看到的都是task_struct ![image-20220729103219065](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729103219065.png) 轻量化：上下文数据不用变了  比起之前的执行 换一个进程 数据，页表和地址空间，甚至缓存数据等等都要换 但是切换线程时这些都不用动 用进程来模拟的 ![image-20220729113527762](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729113527762.png)  之前说CPU进行的是进程调度，到现在加一层理解，CPU调度的其实都是线程 ![image-20220729113829018](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729113829018.png)  ![image-20220729125800585](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729125800585.png)   ![image-20220729130325143](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729130325143.png) ![image-20220729130313212](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729130313212.png) 合适：与计算机核数相当 不合适：线程过多 CPU过多的时间花在切换线程上（同步和调度开销  ![image-20220729150250511](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729150250511.png) ![image-20220729153722753](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729153722753.png)  #### ![image-20220729150804824](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729150804824.png)  ![image-20220729151309339](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729151309339.png) ![image-20220729151321121](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729151321121.png)   ![image-20220729151740976](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729151740976.png) ![](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729151825406.png)   以前是单执行流 两个相等 ![image-20220729152106991](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729152106991.png)   ![image-20220729152556070](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729152556070.png) 一个线程出问题导致进程退出 这也是为什么说线程降低了程序的健壮性 ![image-20220729153537161](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729153537161.png)  ![image-20220729154050200](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729154050200.png)  ![image-20220729155046825](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729155046825.png)  ![image-20220729154750471](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729154750471.png)  ![image-20220729155021524](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729155021524.png) ![image-20220729155622247](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729155622247.png)  ![image-20220729161349626](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729161349626.png)  ![image-20220729160803246](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729160803246.png) ![image-20220729161623417](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729161623417.png)  其他进程干掉主进程 其他线程一直跑导致进程一直处于Z状态 不被回收  ![image-20220729163136584](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729163136584.png)  ![image-20220729163236006](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729163236006.png)  CPU不需要线程的概念   linux下线程这个概念是给用户的  因为用户需要多线程编程 因为不管进程还是线程啊 在linux内核里都是task_struct  linux下进程模拟实现的线程。  线程优点和缺点 斗与共享大量资源有关 进程为什么独立  因为有自己独立的地址空间 页表等。   ![image-20220729212914901](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729212914901.png)  防止内存泄漏  （一直占着资源没释放，有点Z状态的意思 让main线程最后退出（main没了还有别的线程在跑不太合理 获得新线程的退出码（任务做的怎么样    ![image-20220729213353372](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729213353372.png)     ![image-20220730000452672](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730000452672.png) ![image-20220730000249758](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730000249758.png)   ![image-20220730000327168](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730000327168.png)   返回值为void*的解释 ![image-20220730194521066](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730194521066.png)  ![image-20220730203122270](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730203122270.png)   返回一个结构体 ![image-20220730203355531](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730203355531.png) ![image-20220730203415865](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730203415865.png)   ![image-20220730204623368](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730204623368.png)  ![image-20220730210436658](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730210436658.png)   





![image-20220730211214208](C:/Users/ADMIN/AppData/Roaming/Typora/typora-user-images/image-20220730211214208.png)![image-20220730211204292](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730211204292.png)









![image-20220730220614440](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730220614440.png)

![image-20220730220809931](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730220809931.png)

没有线程替换

线程共享地址空间 替换后是整个进程被替换





![image-20220730235208441](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730235208441.png)

第二种就叫分离，分离的本质是让主线程不用再join新线程，让新线程退出的时候自动回收资源



分离的操作。



![image-20220731215711806](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731215711806.png)

![image-20220731220022911](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731220022911.png)

![image-20220731220616647](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731220616647.png)



一个进程出问题等于这个进程出问题。





 native pthread lib 原生线程库

![image-20220731221305068](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731221305068.png)

共享区被所有线程共享



![image-20220731222435978](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731222435978.png)

拿到用户级别的线程id 就可以在库里找到线程相关属性 包括线程的独立栈

![image-20220731222155303](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731222155303.png)





![image-20220731222204100](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731222204100.png)





![image-20220731222447767](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731222447767.png)



原生线程库与系统的关系

库中这个线程的起始地址，用户级线程一旦创建好 对应底层的一个LWP

为什么有线程库







读取全局变量  ![image-20220731224101403](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731224101403.png)

![image-20220731224427305](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731224427305.png)



![image-20220731224624217](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731224624217.png)







访问临界资源的代码就是临界区





![image-20220801231639129](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220801231639129.png)



ticket--不是原子的

![image-20220801232332454](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220801232332454.png)





线程A的时间片到了 CPU寄存器里还有数据 这部分数据就称作上下文数据 也就是临时数据

寄存器是大家共享的 数据是私有的





这种现象的本质是ticket--不是原子性的。

![image-20220801233256743](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220801233256743.png)



![image-20220802011700392](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802011700392.png)









![image-20220802011753144](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802011753144.png)



多多陷入内核

![image-20220802011928141](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802011928141.png)



忘记解锁

![image-20220802095303177](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802095303177.png)



被锁保护起来的代码任何时候都只有一个人在跑

![image-20220802095641237](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802095641237.png)



锁的存在是为了保护临界资源

锁的本身就是一种临界资源  那谁来保护锁？保证lock和unlock是原子的



![image-20220802100406761](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802100406761.png)



![image-20220802100601053](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802100601053.png)

![image-20220802100825553](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802100825553.png)



![image-20220802101005495](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802101005495.png)









01两种状态

![image-20220802105538740](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802105538740.png)

1已经被拿到了x进程的上下文当中 别的进程拿不到了 别的进程再去xchgb只能拿到0  除非释放锁把1还回来

![image-20220802105412456](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802105412456.png)







申请对方的 又不释放自己的 死锁

请求你的锁 又不释放自己的锁

![image-20220802131151422](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802131151422.png)

 



![image-20220802132021577](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802132021577.png)







![image-20220802151119120](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802151119120.png)





![image-20220802152808083](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802152808083.png)





死锁段子

你需要工作经历才能找到工作

![image-20220802153826046](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802153826046.png)



![image-20220802153833166](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802153833166.png)



![image-20220802161622836](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802161622836.png)



![image-20220802164008355](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802164008355.png)



![image-20220802164417578](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802164417578.png)

![image-20220802164455191](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802164455191.png)



![image-20220802165003193](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802165003193.png)



把唤醒一个换成唤醒一批

![image-20220802171459690](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802171459690.png)

![image-20220802170715259](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802170715259.png)

![image-20220802172516656](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802172516656.png)
