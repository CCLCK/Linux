[toc]



ä»çº¿ç¨‹æ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆè¦ç”¨å’Œæ€ä¹ˆç”¨å‡ºå‘ã€‚ä¸‹é¢æ¢è®¨çš„éƒ½æ˜¯linuxä¸‹çš„çº¿ç¨‹

# ğŸ”¥ğŸŒˆğŸŠğŸŒ²ğŸ¥ğŸƒğŸ¬ğŸŒ´ğŸŒ¿ğŸŒµçº¿ç¨‹æ˜¯ä»€ä¹ˆ

> [çº¿ç¨‹ï¼ˆè®¡ç®—æœºæœ¯è¯­ï¼‰_ç™¾åº¦ç™¾ç§‘ (baidu.com)](https://baike.baidu.com/item/çº¿ç¨‹/103101)

çº¿ç¨‹æ˜¯è¿›ç¨‹çš„ä¸€ä¸ªæ‰§è¡Œåˆ†æ”¯ï¼Œæ˜¯åœ¨è¿›ç¨‹å†…éƒ¨è¿è¡Œçš„ä¸€ä¸ªæ‰§è¡Œæµï¼Œæ˜¯æ“ä½œç³»ç»Ÿè¿›è¡Œè¿ç®—è°ƒåº¦çš„æœ€å°å•ä½ã€‚

åœ¨linuxé‡Œæˆ‘ä»¬ä¹ŸæŠŠçº¿ç¨‹æˆä¸ºè½»é‡çº§è¿›ç¨‹ï¼ˆLWPï¼ŒLightWeightProcessï¼‰,å› ä¸ºlinuxé‡Œå…¶å®æ²¡æœ‰çœŸæ­£çš„çº¿ç¨‹ï¼Œçº¿ç¨‹æ˜¯é€šè¿‡è¿›ç¨‹æ¨¡æ‹Ÿå‡ºæ¥çš„ï¼ˆåœ¨å†…æ ¸é‡Œéƒ½æ˜¯ä¸€ä¸ªä¸ªçš„task_struct)ã€‚

æ²¡å­¦çº¿ç¨‹å‰æˆ‘ä»¬è¯´è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿæœ€å°çš„è°ƒåº¦å•ä½ï¼Œå› ä¸ºé‚£æ—¶æˆ‘ä»¬å†™çš„ä»£ç éƒ½æ˜¯å•çº¿ç¨‹çš„ï¼Œä¸€ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªæ‰§è¡Œæµï¼Œæ‰€ä»¥é‚£ä¹ˆè¯´ä¹Ÿæ²¡é”™ï¼Œå‡†ç¡®ä¸€ç‚¹å°±æ˜¯çº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿè°ƒåº¦çš„æœ€å°å•ä½ã€‚

å•æ‰§è¡Œæµ

![image-20220804103802340](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220804103802340.png)

å¤šæ‰§è¡Œæµ

![image-20220804104624107](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220804104624107.png)

é€šè¿‡ä¸Šé¢ä¸¤å¼ å›¾å¾—å‡ºçš„ä¸€äº›ç»“è®ºï¼ŒåŒæ—¶è¡¥å……ä¸€äº›æ¦‚å¿µï¼š

- ç«™åœ¨CPUçš„è§’åº¦ï¼Œè¿›ç¨‹ä¸çº¿ç¨‹æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œå®ƒçœ‹åˆ°çš„éƒ½æ˜¯task_struct,è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆçº¿ç¨‹åœ¨linuxé‡Œä¹Ÿå«è½»é‡çº§è¿›ç¨‹ï¼Œä¹Ÿè¯´æ˜linuxä¸‹æ²¡æœ‰çœŸæ­£æ„ä¹‰ä¸Šçš„çº¿ç¨‹ã€‚ç®€å•æ¥è¯´ï¼ŒCPUå¯¹çº¿ç¨‹0æ„ŸçŸ¥ã€‚
- çº¿ç¨‹ä¹‹é—´æ˜¯å…±ç”¨ä¸€ä¸ªåœ°å€ç©ºé—´çš„ï¼Œè¿™è¯´æ˜æ¯”èµ·è¿›ç¨‹ä¹‹é—´çš„åˆ‡æ¢ï¼Œçº¿ç¨‹çš„åˆ‡æ¢æ›´åŠ è½»é‡çº§ã€‚å› ä¸ºè¿›ç¨‹åˆ‡æ¢å¯èƒ½è¦ä¿å­˜é¡µè¡¨ã€åœ°å€ç©ºé—´çš„æ•°æ®ç”šè‡³ç¼“å­˜çš„æ•°æ®ç­‰ç­‰ï¼Œè€Œçº¿ç¨‹ä¹‹é—´åˆ‡æ¢æ—¶è¿™äº›éƒ½ä¸ç”¨åŠ¨ï¼Œè‡ªç„¶åˆ‡æ¢çš„ä»£ä»·ä¹Ÿæ¯”è¾ƒå°ã€‚
- è¿›ç¨‹ï¼šçº¿ç¨‹=1ï¼šnï¼Œè¯´æ˜ç³»ç»Ÿå†…æœ‰å¤§é‡çš„çº¿ç¨‹ï¼Œæ‰€ä»¥æ“ä½œç³»ç»Ÿå¿…å®šè¦æŠŠçº¿ç¨‹ç®¡ç†èµ·æ¥ï¼Œè¯´æ˜å¦‚æœä¸€ä¸ªç³»ç»Ÿæ”¯æŒçœŸæ­£çš„çº¿ç¨‹ï¼Œæ¯”å¦‚windowsï¼Œé‚£å¿…ç„¶æ˜¯æœ‰ä¸€ä¸ªç»“æ„ï¼ˆTCBï¼‰æ¥æè¿°è¿™ä¸ªçº¿ç¨‹çš„å±æ€§ï¼Œå¹¶ä¸”å°†å…¶ç»„ç»‡èµ·æ¥ï¼Œä½†æ˜¯å¾€å¾€æ¯”è¾ƒå¤æ‚ï¼Œlinuxä¸‹è™½ç„¶æ²¡æœ‰çœŸæ­£çš„çº¿ç¨‹ï¼Œä½†æ˜¯ä¼˜ç‚¹å°±æ˜¯ç®€å•ã€‚
- linuxä¸‹æ²¡æœ‰çœŸæ­£æ„ä¹‰çš„çº¿ç¨‹ï¼Œè¿™å°±è¯´æ˜OSä¸å¯èƒ½åœ¨ç³»ç»Ÿå±‚é¢æä¾›æ“ä½œçº¿ç¨‹çš„æ¥å£ï¼Œè€Œæ˜¯ä¸€äº›å°è£…å¥½ç»™ç”¨æˆ·çš„è½»é‡çº§æ¥å£ã€‚
- CPUè°ƒåº¦çš„éƒ½æ˜¯çº¿ç¨‹ï¼Œå³çº¿ç¨‹æ˜¯CPUè°ƒåº¦çš„æœ€å°å•ä½
- ç«™åœ¨ç³»ç»Ÿçš„è§’åº¦ï¼Œè¿›ç¨‹æ˜¯æ‰¿æ‹…ç³»ç»Ÿèµ„æºçš„åŸºæœ¬å•ä½ã€‚å› ä¸ºç¬¬äºŒä¸ªçº¿ç¨‹ç”¨çš„èµ„æºéƒ½æ˜¯ç¬¬ä¸€ä¸ªçº¿ç¨‹ç”³è¯·å¥½çš„ã€‚
- çº¿ç¨‹åœ¨è¿›ç¨‹å†…éƒ¨è¿è¡Œï¼Œè¿™å¥è¯çš„æ„æ€æ˜¯çº¿ç¨‹åœ¨è¿›ç¨‹åœ°å€ç©ºé—´å†…è¿è¡Œã€‚
- é€šè¿‡é¡µè¡¨å¯ä»¥çœ‹åˆ°ç‰©ç†å†…å­˜ï¼Œä¹Ÿå³çœŸæ­£çš„èµ„æºï¼ŒåŒæ—¶è¯´æ˜åªè¦åˆ’åˆ†é¡µè¡¨æˆ‘ä»¬å°±å¯ä»¥è®©çº¿ç¨‹çœ‹åˆ°è¿›ç¨‹çš„éƒ¨åˆ†èµ„æºã€‚
- å…³äºé¡µè¡¨ï¼Œé¡µè¡¨ä¸ä»…ä»…è®°å½•äº†è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€çš„æ˜ å°„ï¼Œè¿˜æœ‰ä¸€äº›åˆ«çš„å±æ€§ï¼Œå¦‚æƒé™ï¼Œæ˜¯å¦å‘½ä¸­ç­‰ç­‰ï¼Œè¿™è¯´æ˜é¡µè¡¨çš„å¤§å°ä¸æ˜¯ä¸€ä¸ªå­—èŠ‚å°±èƒ½è®°å½•çš„ã€‚ä¸€èˆ¬32ä½çš„æœºå™¨ç‰©ç†å†…å­˜æ˜¯4Gï¼Œè¯´æ˜æœ‰2^32^è¿™ä¹ˆå¤šä¸ªåœ°å€è¦æ˜ å°„ï¼Œå³é¡µè¡¨è¦è®°å½•2^32^ä¸ªæ˜ å°„å…³ç³»ï¼Œè¡¨ç¤ºæ¯ä¸€ä¸ªæ˜ å°„å…³ç³»éœ€è¦çš„å­—èŠ‚éƒ½å¤§äº1ï¼Œè¯´æ˜é¡µè¡¨æ•´ä½“å¤§å°å¤§äº4Gï¼Œæ”¾ä¸è¿›å†…å­˜ï¼Œæ­¤æ—¶å°±å¼•å‡ºäº†äºŒçº§é¡µè¡¨ã€‚è´Ÿè´£è¿™å—çš„ç¡¬ä»¶å°±æ˜¯MMUï¼Œå…·ä½“çš„äº†è§£å¯ä»¥æŸ¥è¯¢äºŒçº§é¡µè¡¨çš„ç›¸å…³èµ„æ–™ã€‚
- çº¿ç¨‹æ•°è¶Šå¤šè¶Šå¥½å—ï¼Ÿå¹¶ä¸æ˜¯ï¼Œå»ºè®®ä¸è®¡ç®—æœºçš„æ ¸æ•°ç›¸å½“ã€‚çº¿ç¨‹è¿‡å¤šä¼šå¯¼è‡´å¤§éƒ¨åˆ†æ—¶é—´èŠ±åœ¨è°ƒåº¦ä¸Šï¼Œè€Œæ²¡æœ‰èŠ±åœ¨çº¿ç¨‹çš„æ‰§è¡Œä¸Šï¼Œæœ‰ç‚¹ä¹°æ¤Ÿè¿˜ç çš„æ„æ€ã€‚          
- æ²¡æœ‰çº¿ç¨‹æ›¿æ¢ï¼Œçº¿ç¨‹æ›¿æ¢å°±æ˜¯æ•´ä¸ªè¿›ç¨‹è¢«æ›¿æ¢ã€‚           
- CPUä¸éœ€è¦çº¿ç¨‹çš„æ¦‚å¿µï¼Œlinuxä¸‹çº¿ç¨‹è¿™ä¸ªæ¦‚å¿µæ˜¯ç»™ç”¨æˆ·çš„ï¼Œå› ä¸ºç”¨æˆ·éœ€è¦å¤šçº¿ç¨‹ç¼–ç¨‹       
- ç”¨æˆ·å±‚é€šè¿‡TCBæ¥çŸ¥é“çº¿ç¨‹çš„idã€çŠ¶æ€ã€ä¼˜å…ˆçº§å’Œå…¶ä»–å±æ€§ï¼Œç”¨æ¥è¿›è¡Œç”¨æˆ·çº§çš„çº¿ç¨‹ç®¡ç†ã€‚TCBä¸ç”±å†…æ ¸ç»´æŠ¤ï¼Œè€Œæ˜¯ç”±ç”¨æˆ·ç©ºé—´ç»´æŠ¤ã€‚               

> éšç¬”è®°å½•:[ä¸€ä¸ªç¨‹åºè¢«åŠ è½½åˆ°å†…å­˜ï¼Œç³»ç»Ÿå°±åˆ›å»ºäº†ä¸€ä¸ªè¿›ç¨‹ã€‚è¯·é—®è¿™å¥è¯ä»€ä¹ˆæ„æ€ï¼Ÿä¸ºä»€ä¹ˆè¦å…ˆåŠ è½½åˆ°å†…å­˜ï¼Ÿ (sogou.com)](https://wenwen.sogou.com/question/q710120053.htm)
>
> ![image-20220804112357220](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220804112357220.png)



# ğŸŒ²çº¿ç¨‹å¸¸è§æ¥å£ä½¿ç”¨

çº¿ç¨‹çš„ä¼˜ç¼ºç‚¹æ”¾åœ¨æœ€åï¼Œç›´æ¥è´´åœ¨è¿™é‡Œæœ‰ç‚¹å¤ªæŠ½è±¡äº†ã€‚

ç›¸å…³æ¥å£çš„ä½¿ç”¨ç»†èŠ‚å¯ä»¥ç”¨manå‘½ä»¤æŸ¥è¯¢ï¼Œä¸‹é¢ç›´æ¥è´´åŸºæœ¬ç”¨æ³•ã€‚

## ğŸŒµç›¸å…³æ¦‚å¿µè¡¥å……

çº¿ç¨‹ä¹‹é—´æœ‰å…±äº«è¿›ç¨‹æ•°æ®ï¼Œä½†ä¹Ÿæœ‰ç‹¬æœ‰çš„èµ„æºã€‚

å…±äº«çš„èµ„æºï¼šè¿›ç¨‹ä»£ç æ®µã€è¿›ç¨‹çš„å…¬æœ‰æ•°æ®ï¼Œè¿›ç¨‹æ‰€æ‹¥æœ‰çš„çš„èµ„æºã€‚

**ç‹¬æœ‰çš„èµ„æºï¼š**å¯„å­˜å™¨å†…çš„æ•°æ®ï¼Œçº¿ç¨‹çš„ç‹¬ç«‹æ ˆï¼Œè‡ªå·±çš„çŠ¶æ€ï¼ˆå¦‚è‡ªå·±çš„çº¿ç¨‹idã€è°ƒåº¦ä¼˜å…ˆçº§ã€ä¿¡å·å±è”½å­—ã€errnoç­‰ï¼‰ã€‚**å¯ä»¥æ¦‚æ‹¬ä¸º<font color=red>ä¸Šä¸‹æ–‡æ•°æ®å’Œç‹¬ç«‹çš„æ ˆç»“æ„</font>ï¼Œä¸Šä¸‹æ–‡æ•°æ®è¯´æ˜çº¿ç¨‹çº¿ç¨‹æ˜¯å¯ä»¥è¢«åˆ‡æ¢çš„ï¼Œç‹¬ç«‹çš„æ ˆç»“æ„è¯´æ˜çº¿ç¨‹æ˜¯ç‹¬ç«‹è¿è¡Œçš„ã€‚**

> è¿›ç¨‹åœ°å€ç©ºé—´é‡Œä¸æ˜¯æœ‰ä¸€ä¸ªæ ˆäº†ï¼Œé‚£è¿™ä¸ªç‹¬ç«‹æ ˆåœ¨å“ªï¼Ÿåœ¨å…±äº«åŒºã€‚
>
> ![image-20220805104604626](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220805104604626.png)
>
> tid1å’Œtid2ä¸¤ä¸ªå€¼æœ¬è´¨æ˜¯ä¸€ä¸ªåœ°å€ï¼Œè¿›ç¨‹åœ°å€ç©ºé—´å†…çš„æ ˆåªèƒ½è¢«ä¸»çº¿ç¨‹ç”¨ï¼Œåˆ«çš„çº¿ç¨‹æœ‰è‡ªå·±çš„ç‹¬ç«‹æ ˆï¼Œåœ¨å…±äº«åŒºå†…ã€‚
>
> åˆ é™¤çº¿ç¨‹å°±æ˜¯åˆ æ‰å†…æ ¸çº§åˆ«çš„LWPï¼Œå†é‡Šæ”¾å…±äº«åŒºé‡Œçš„èµ„æºï¼ˆæ•°æ®ç»“æ„ï¼‰ã€‚

ä¸€ä¸ªçº¿ç¨‹å¼‚å¸¸ç»ˆæ­¢ï¼Œä¼šå¯¼è‡´æ•´ä¸ªè¿›ç¨‹ç»ˆæ­¢ã€‚æ¯”å¦‚çº¿ç¨‹ä¸­å‡ºç°é™¤é›¶é”™è¯¯ã€é‡æŒ‡é’ˆè¶Šç•Œç­‰ï¼Œè¿›ç¨‹å°±ä¼šè§¦å‘ä¿¡å·æœºåˆ¶ï¼Œç³»ç»Ÿå°±å‘é€ä¸€ä¸ªä¿¡å·ç»ˆæ­¢è¿›ç¨‹ï¼ˆå› ä¸ºä¿¡å·æ˜¯é’ˆå¯¹è¿›ç¨‹è€Œä¸æ˜¯é’ˆå¯¹çº¿ç¨‹çš„ï¼‰ã€‚

äº†è§£ï¼švfork()çš„ä½¿ç”¨ï¼Œç®€å•æ¥è¯´ï¼Œåˆ›å»ºå­è¿›ç¨‹å¹¶è®©çˆ¶è¿›ç¨‹é˜»å¡ï¼Œå¹¶ä¸”å­è¿›ç¨‹å…±äº«çˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œä¸€èˆ¬vforkå‡ºæ¥çš„å­è¿›ç¨‹éƒ½æ˜¯ä¸ºäº†æ›¿æ¢ï¼Œå› ä¸ºè¿™ç§æ›¿æ¢åä¸éœ€è¦çˆ¶è¿›ç¨‹çš„æ•°æ®ä¹Ÿå°±ä¸éœ€è¦åƒfork()ä¸€æ ·å»æ‹·è´çˆ¶è¿›ç¨‹çš„è¿›ç¨‹åœ°å€ç©ºé—´ã€‚å…·ä½“ä½¿ç”¨å¯ä»¥æŸ¥è¯¢èµ„æ–™å’Œæ–‡æ¡£ã€‚

## ğŸŒµpthread_createåˆ›å»ºçº¿ç¨‹

åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼ŒæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›ä¸€ä¸ªé”™è¯¯ç ã€‚

    #include <pthread.h>
    int pthread_create(pthread_t *thread, const pthread_attr_t *attr,void *(*start_routine) (void *),
    	 void *arg);
    Compile and link with -pthread.

thread:è¾“å‡ºå‹å‚æ•°ï¼Œè¿”å›åˆ›å»ºçš„çº¿ç¨‹çš„idã€‚

attr:è®¾ç½®çº¿ç¨‹çš„å±æ€§ï¼Œatträ¸ºNULLè¡¨ç¤ºé»˜è®¤å±æ€§

start_routineï¼šå‡½æ•°æŒ‡é’ˆï¼Œè¡¨ç¤ºçº¿ç¨‹å¯åŠ¨åè¦æ‰§è¡Œçš„å‡½æ•°ã€‚å‡½æ•°è¿”å›å€¼å’Œå‚æ•°éƒ½ä¸ºvoid*ã€‚

> å‚æ•°æ˜¯void*,"void * "è¢«ç§°ä¸ºä¸‡èƒ½æŒ‡é’ˆï¼Œå¯ä»¥å¸®åŠ©æ¥æ”¶å„ç§å‚æ•°ã€‚

arg:ä¼ ç»™çº¿ç¨‹å¯åŠ¨å‡½æ•°çš„å‚æ•°ã€‚

**ç¼–è¯‘æ—¶è¦åŠ lpthreadé€‰é¡¹**ï¼Œè¡¨ç¤ºé“¾æ¥åˆ°pthreadåº“

> - å…³äºpthread_tç±»å‹ï¼Œtypedef uintptr_t pthread_t;uintptr_tæ˜¯unsigned long intã€‚ä½†æ˜¯æˆ‘ä»¬ä¸åº”è¯¥è¿™ä¹ˆåšï¼Œå› ä¸ºpthread_tæ˜¯ä¸€ä¸ªä¸é€æ˜çš„ç±»å‹ï¼Œæ ¹æ®å¹³å°ä¸åŒå®ç°ä¹Ÿä¸åŒï¼Œæ‰€ä»¥ä¸åº”è¯¥ç”¨æ— ç¬¦å·é•¿æ•´å½¢å»å®šä¹‰å®ƒã€‚
>
> è¿™é‡Œæˆ‘ä»¬åªéœ€çŸ¥é“çº¿ç¨‹IDçš„ç±»å‹æ˜¯pthread_tã€‚åˆ¤æ–­ä¸¤ä¸ªçº¿ç¨‹IDç›¸ç­‰ä¹Ÿåº”è¯¥ç”¨ç›¸åº”çš„æ¥å£ï¼Œè€Œä¸æ˜¯â€œ==â€ï¼Œå°½ç®¡çº¿ç¨‹IDæ‰“å°å‡ºæ¥æ˜¯ä¸€ä¸ªæ•°å­—ã€‚
>
> - å…³äºâ€œCompile and link with -pthread.â€
>
> ![image-20220805101751853](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220805101751853.png)



### ğŸƒä¾‹å­

åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹æ¯éš”1sæ‰“å°ä¸€æ¬¡ï¼Œæ–°çº¿ç¨‹æ¯éš”2sæ‰“å°ä¸€æ¬¡ã€‚

```cpp
#include <iostream>
#include <pthread.h>
#include<unistd.h>
using namespace std;

void* routine(void* args)//æ–°çº¿ç¨‹æ‰§è¡Œçš„å‡½æ•°
{
  while(true)
  {
    cout<<(char*)args<<endl;
    sleep(2);
  }
  return nullptr;
}

int main()
{
  pthread_t tid;
  pthread_create(&tid,nullptr,routine,(void*)"thread 1");//åˆ›å»ºæ–°çº¿ç¨‹

  while(true)
  {
    cout<<"main thread is running"<<endl;
    sleep(1);
  }
  return 0;
}
```

![image-20220804161000876](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220804161000876.png)

## ğŸŒµpthread_self()è·å–çº¿ç¨‹è‡ªèº«id

è·å–å½“å‰çº¿ç¨‹çš„idï¼Œå‡½æ•°è°ƒç”¨æ€»æ˜¯æˆåŠŸï¼Œè¿”å›å€¼ä¸ºçº¿ç¨‹idã€‚

```c
#include <pthread.h>

pthread_t pthread_self(void);
Compile and link with -pthread.
```

### ğŸƒä¾‹å­1

æ¯éš”1sæ‰“å°ä¸»çº¿ç¨‹å’Œæ–°çº¿ç¨‹çš„çº¿ç¨‹id

```cpp
#include <iostream>
#include <pthread.h>
#include<unistd.h>
using namespace std;

void* routine(void* args)
{
  while(true)
  {
    cout<<"thread1 id: "<<pthread_self()<<endl;
    sleep(1);
  }
  return nullptr;
}

int main()
{
  pthread_t tid;
  pthread_create(&tid,nullptr,routine,(void*)"thread 1");

  while(true)
  {
    //cout<<"main thread is running"<<endl;
    cout<<"main thread id: "<<pthread_self()<<endl;
    sleep(1);
  
  }
  return 0;
}
```

![image-20220804171207728](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220804171207728.png)

### ğŸ¥ps-aLå‘½ä»¤æŸ¥çœ‹ç³»ç»Ÿè½»é‡çº§è¿›ç¨‹

```shell
ps -aL  //è¿™é‡ŒæŸ¥çœ‹çš„è¿›ç¨‹æ˜¯ä¸Šé¢çš„ä¾‹å­
```

å¯ä»¥çœ‹åˆ°è¿›ç¨‹idç›¸åŒï¼Œå› ä¸ºä¸¤ä¸ªçº¿ç¨‹å±äºåŒä¸€ä¸ªè¿›ç¨‹ï¼Œä¸»çº¿ç¨‹idå’Œæ–°çº¿ç¨‹idä¸åŒï¼Œä¸»çº¿ç¨‹çš„PIDå’ŒLWPç›¸åŒã€‚

![image-20220804171503949](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220804171503949.png)

å¯ä»¥çœ‹åˆ°ä¾‹å­é‡Œæ‰“å°çš„çº¿ç¨‹pthread_tè¡¨ç¤ºçš„çº¿ç¨‹IDå’ŒLWPè¡¨ç¤ºçš„çº¿ç¨‹IDä¸åŒï¼Œç›´æ¥ç»™ç»“è®ºï¼ŒLWPæ˜¯ç³»ç»Ÿå”¯ä¸€æ ‡è¯†çº¿ç¨‹çš„IDï¼Œ**pthread_tå˜é‡çš„å€¼æœ¬è´¨æ˜¯è¿›ç¨‹åœ°å€ç©ºé—´ä¸Šå…±äº«åŒºçš„ä¸€ä¸ªèµ·å§‹åœ°å€ï¼Œæ˜¯ç”¨æˆ·å±‚çš„çº¿ç¨‹idã€‚**

æ‹¿åˆ°ç”¨æˆ·çº§åˆ«çš„çº¿ç¨‹idï¼Œå°±å¯ä»¥åœ¨åº“é‡Œæ‰¾åˆ°çº¿ç¨‹ç›¸å…³å±æ€§ï¼ŒåŒ…æ‹¬çº¿ç¨‹çš„ç‹¬ç«‹æ ˆã€‚

### ğŸƒä¾‹å­2

å¾ªç¯åˆ›å»ºå¤šä¸ªè¿›ç¨‹ï¼Œåˆ©ç”¨æ•°ç»„+æŒ‡é’ˆè®©çº¿ç¨‹è°ƒç”¨çš„å‡½æ•°çŸ¥é“è‡ªå·±æ˜¯ç¬¬å‡ ä¸ªçº¿ç¨‹ã€‚

```cpp
#include <iostream>
#include <pthread.h>
#include<unistd.h>
using namespace std;

void* routine(void* args)//å‚æ•°ä¸ºvoid*å¯ä»¥å¸®åŠ©æ¥æ”¶å„ç§å‚æ•°
{
  while(true)
  {
    cout<<"thread"<<*(int*)args<<" id: "<<pthread_self()<<endl;
    sleep(2);
  }
  return nullptr;
}

int main()
{
  pthread_t tid[5];
  for(int i=0;i<5;i++)
  {
    int* p=new int(i);
     pthread_create(tid+i,nullptr,routine,(void*)p);

  }

  while(true)
  {
    //cout<<"main thread is running"<<endl;
    cout<<"main thread id: "<<pthread_self()<<endl;
    sleep(2);
  
  }
  return 0;
}
```

![image-20220805110033792](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220805110033792.png)

## ğŸŒµpthread_join()ç­‰å¾…çº¿ç¨‹

### ğŸ¥ä¸ºä»€ä¹ˆè¦ç­‰å¾…çº¿ç¨‹å‘¢ï¼Ÿ

- é˜²æ­¢å†…å­˜æ³„æ¼ï¼ˆä¸€ç›´å ç€èµ„æºæ²¡é‡Šæ”¾ï¼‰
- è®©mainçº¿ç¨‹æœ€åé€€å‡ºï¼ˆmainæ²¡äº†åˆ«çš„çº¿ç¨‹è¿˜åœ¨è·‘ä¸åˆç†ï¼‰
- è·çš„æ–°çº¿ç¨‹çš„é€€å‡ºç ï¼ˆä»»åŠ¡åšçš„æ€ä¹ˆæ ·ï¼‰

å’Œç­‰å¾…è¿›ç¨‹ç±»ä¼¼ï¼Œæˆ‘ä»¬åˆ›å»ºçº¿ç¨‹æ˜¯ç»™äº†ä»–å¯¹åº”çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬æ˜¯éœ€è¦çŸ¥é“è¿™ä¸ªçº¿ç¨‹æŠŠè¿™ä¸ªä»»åŠ¡åšçš„æ€ä¹ˆæ ·çš„ï¼Œæ­¤å¤–ï¼Œå·²ç»é€€å‡ºçš„çº¿ç¨‹ç©ºé—´æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œä»ç„¶ä¼šåœ¨è¿›ç¨‹çš„åœ°å€ç©ºé—´å†…å ç”¨ç€èµ„æºï¼Œå¯ä»¥ä¿è¯åˆ›å»ºæ–°çš„çº¿ç¨‹ä¸ä¼šå¤ç”¨æ—§çº¿ç¨‹çš„åœ°å€ç©ºé—´ã€‚

> ä¸ç­‰å¾…ä¼šæ€ä¹ˆæ ·ï¼Ÿèµ„æºä¸€ç›´æ²¡æœ‰è¢«å›æ”¶ï¼Œé€ æˆç±»ä¼¼åƒµå°¸è¿›ç¨‹çš„é—®é¢˜ã€‚

ç­‰å¾…çš„æ—¶å€™è¦ä¸è¦è€ƒè™‘çº¿ç¨‹å´©æºƒçš„é—®é¢˜ï¼Ÿä¸éœ€è¦ï¼Œçº¿ç¨‹å´©äº†è¡¨ç¤ºè¿›ç¨‹å´©äº†ã€‚

### ğŸ¬æ¥å£ä½¿ç”¨

pthread_join()ç­‰å¾…çº¿ç¨‹ï¼ŒæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›é”™è¯¯ç ã€‚

```c
#include <pthread.h>

int pthread_join(pthread_t thread, void **retval);

Compile and link with -pthread.
```

ç¬¬ä¸€ä¸ªthreadä¼ è¿›ç¨‹æ ‡è¯†ç¬¦,è¿™é‡Œä¸æ˜¯ä¼ æŒ‡é’ˆäº†.

ç¬¬äºŒä¸ªä¼ å‚æ•°retvalä¼ äºŒçº§æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆæ˜¯ä¸€ä¸ªè¾“å‡ºå‹å‚æ•°ï¼Œå¯ä»¥è·å–è¿›ç¨‹çš„é€€å‡ºç ï¼Œä¹Ÿå¯ä»¥è·å–æ›´åŠ è¯¦ç»†çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ç”¨ç»“æ„ä½“æè¿°é€€å‡ºä¿¡æ¯ã€‚

> çº¿ç¨‹æ‰§è¡Œçš„å‡½æ•°routineçš„è¿”å›å€¼æ˜¯void *ï¼Œè¿™è¯´æ˜è¿”å›å€¼å¦‚æœæ˜¯æ•°å­—ï¼ˆé€€å‡ºç ï¼‰çš„è¯é‚£å°±æ˜¯void *,æ›´æ”¹void *çš„å€¼åº”è¯¥ç”¨void ** ï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªå‚æ•°ä¸ºäºŒçº§æŒ‡é’ˆã€‚

- æ³¨æ„pthread_joinæ˜¯**é˜»å¡ç­‰å¾…**çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©æ‰€æœ‰çº¿ç¨‹è¿è¡Œå®Œäº†ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©è¿è¡Œä¸€ä¸ªçº¿ç¨‹å°±ç­‰å¾…ä¸€ä¸ªçº¿ç¨‹ã€‚å…·ä½“æƒ…å†µå…·ä½“åˆ†æã€‚

- å¦‚æœä¸å…³å¿ƒçº¿ç¨‹é€€å‡ºçš„çŠ¶æ€ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ ç©ºæŒ‡é’ˆå³å¯ã€‚

### ğŸƒä¾‹å­

åˆ›å»ºäº”ä¸ªçº¿ç¨‹ï¼Œç”¨ç»“æ„ä½“æ¥æè¿°é€€å‡ºä¿¡æ¯ï¼Œä¸»çº¿ç¨‹ç­‰å¾…å¹¶è·å–é€€å‡ºä¿¡æ¯ã€‚

```cpp
#include <iostream>
#include <pthread.h>
#include<unistd.h>
#include<string>
using namespace std;

struct exit_code
{
  int code;
  string info;
};

void* routine(void* args)
{
  int cnt=3;
  while(cnt--)
  {
    cout<<"thread"<<*(int*)args<<" id: "<<pthread_self()<<" cnt: "<<cnt<<endl;
    sleep(1);
  }
  exit_code* p=new exit_code();
  p->code=10;
  p->info="thread quit normal!";
  return p;
}

int main()
{
  pthread_t tid[5];
  for(int i=0;i<5;i++)
  {
    int* p=new int(i);
    pthread_create(tid+i,nullptr,routine,(void*)p);
//    void* st=nullptr;//åˆå§‹åŒ–ä¸€ä¸‹,è¿™é‡Œæ˜¯ä¸€ä¸ªçº¿ç¨‹è·‘å®Œå°±ç­‰ä¸€ä¸ªçº¿ç¨‹
//    åˆ›å»ºä¸€ä¸ªçº¿ç¨‹åï¼Œä¸»çº¿ç¨‹ä¸€ç›´é˜»å¡åœ¨è¿™ï¼Œä¸ä¼šå†åˆ›å»ºä¸‹ä¸€ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥ä¸€ä¸ªçº¿ç¨‹è·‘å®Œç­‰å¾…å®Œäº†æ‰ä¼šåˆ›å»ºä¸‹ä¸€ä¸ªè¿›ç¨‹
//    if(pthread_join(tid[i],&st)==0)
//    {
//      cout<<"thread exit code: "<<((exit_code*)(st))->code<<" "<<((exit_code*)(st))->info<<endl;
//    }
  }
//è·‘å®Œæ‰€æœ‰çº¿ç¨‹åé›†ä¸­ç­‰å¾…å¹¶è·å–é€€å‡ºç ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿä¿è¯äº†ä¸»çº¿ç¨‹æœ€åé€€å‡º
 for(int i=0;i<5;i++)
 {
    void* st=nullptr;//åˆå§‹åŒ–ä¸€ä¸‹
    if(pthread_join(tid[i],&st)==0)
    {
      cout<<"thread exit code: "<<((exit_code*)(st))->code<<" "<<((exit_code*)(st))->info<<endl;
    }
 }
  return 0;
}
```



![image-20220805160100552](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220805160100552.png)

> å¦‚æœæƒ³çŸ¥é“å…·ä½“ç­‰å¾…çš„æ˜¯å“ªä¸ªè¿›ç¨‹å¯ä»¥åœ¨ç»“æ„ä½“ä¼ å…¥çº¿ç¨‹IDã€‚

## ğŸŒµpthread_exit()ç»ˆæ­¢çº¿ç¨‹

### ğŸ¥ç»ˆæ­¢çº¿ç¨‹çš„æ–¹æ³•

- return
- pthread_exit
- pthread_cancel

ä¸èƒ½ç”¨exité€€å‡ºï¼Œexitæ˜¯ç”¨æ¥é€€å‡ºè¿›ç¨‹çš„

### ğŸ¬æ¥å£ä½¿ç”¨

```c
pthread_exit - terminate calling thread
#include <pthread.h>
void pthread_exit(void *retval);
Compile and link with -pthread.
```

ä¸€ä¸ªå‚æ•°:æŒ‡é’ˆretvalã€‚è¿™ä¸ªæŒ‡é’ˆä¸èƒ½æŒ‡å‘å±€éƒ¨å˜é‡ï¼Œä¸ç„¶çº¿ç¨‹é€€å‡ºå±€éƒ¨å˜é‡é‚£å—ç©ºé—´ä¹Ÿè¢«â€œé”€æ¯â€äº†ã€‚

### ğŸƒä¾‹å­

```cpp
#include <iostream>
#include <pthread.h>
#include<unistd.h>
#include<string>
using namespace std;

struct exit_code
{
  int code;
  string info;
};

void* routine(void* args)
{
  int cnt=3;
  while(cnt--)
  {
    cout<<"thread"<<*(int*)args<<" id: "<<pthread_self()<<" cnt: "<<cnt<<endl;
    sleep(1);
  }
  pthread_exit((void*)10);//è®¾ç½®é€€å‡ºç 
}

int main()
{
  pthread_t tid[5];
  for(int i=0;i<5;i++)
  {
    int* p=new int(i);
    pthread_create(tid+i,nullptr,routine,(void*)p);
  }

 for(int i=0;i<5;i++)
 {
    void* ret=nullptr;//åˆå§‹åŒ–ä¸€ä¸‹
    if(pthread_join(tid[i],&ret)==0)
    {    
      cout<<"thread exit code: "<<(int)(ret)<<endl;
    }
 }

  return 0;
}
```

![image-20220805162623964](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220805162623964.png)

## ğŸŒµpthread_cancel()å–æ¶ˆæ‰§è¡Œä¸­çš„çº¿ç¨‹

```c
pthread_cancel - send a cancellation request to a thread

#include <pthread.h>
int pthread_cancel(pthread_t thread);

Compile and link with -pthread.
```

å‚æ•°threadè¡¨ç¤ºè¦å–æ¶ˆçš„çº¿ç¨‹ID

è°ƒç”¨æˆåŠŸè¿”å›0ï¼Œå¦åˆ™è¿”å›é0ã€

- cancelæœ¬èº«å…·æœ‰ä¸€å®šçš„å»¶æ—¶æ€§ï¼Œå¹¶ä¸æ˜¯ç«‹å³å¤„ç†çš„ï¼Œæ‰€ä»¥ä¸»çº¿ç¨‹å–æ¶ˆå…¶ä»–çº¿ç¨‹æ—¶å¾—å…ˆä¿è¯å…¶ä»–çº¿ç¨‹è·‘èµ·æ¥äº†

- å¦‚æœä¸€ä¸ªçº¿ç¨‹è¢«å…¶ä»–çº¿ç¨‹pthread_cancelå¼‚å¸¸ç»ˆæ­¢æ‰ï¼Œçº¿ç¨‹å‡½æ•°çš„è¿”å›å€¼ä¼šè¢«è®¾å®šä¸ºPTHREAD_CANCELEDï¼ŒPTHREAD_CANCELEDæœ¬è´¨æ˜¯ä¸€ä¸ªå®

  ```c
  #define PTHREAD_CANCELED ((void *) -1)
  ```

### ğŸƒä¾‹å­

åˆ›å»ºäº”ä¸ªè¿›ç¨‹ï¼Œ2såå–æ¶ˆåä¸‰ä¸ªçº¿ç¨‹ã€‚

```cpp
#include <iostream>
#include <pthread.h>
#include<unistd.h>
#include<string>
using namespace std;

void* routine(void* args)
{
  int cnt=3;
  while(cnt--)
  {
    cout<<"thread"<<*(int*)args<<" id: "<<pthread_self()<<" cnt: "<<cnt<<endl;
    sleep(1);
  }
    pthread_exit((void*)10);
}

int main()
{
  pthread_t tid[5];
  for(int i=0;i<5;i++)
  {
    int* p=new int(i);
    pthread_create(tid+i,nullptr,routine,(void*)p);

  }
 sleep(2);//è®©çº¿ç¨‹éƒ½è·‘èµ·æ¥ï¼Œä¸ç„¶æ–°çº¿ç¨‹å¯èƒ½è¢«åˆ›å»ºäº†ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è¢«è°ƒåº¦ï¼Œå¯¼è‡´å–æ¶ˆå‡ºé—®é¢˜
  for(int i=2;i<5;i++)
  {
    pthread_cancel(tid[i]);
  }
 for(int i=0;i<5;i++)
 {
    void* ret=nullptr;//åˆå§‹åŒ–ä¸€ä¸‹
    if(pthread_join(tid[i],&ret)==0)
    {
      cout<<"thread join success "<<endl;
    }
 }

  return 0;
}
```

![image-20220805165025012](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220805165025012.png)

### ğŸƒä¾‹å­2

å­çº¿ç¨‹å¹²æ‰ä¸»çº¿ç¨‹å¯¼è‡´ä¸»çº¿ç¨‹åƒµå°¸ã€‚æ­¤æ—¶å¦‚æœå­çº¿ç¨‹ä¸€ç›´åœ¨è·‘å°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼ˆè¦æ¨¡æ‹Ÿè¿™ä¸ªæƒ…å†µåŠ ä¸Šä¸€ä¸ªæ­»å¾ªç¯å³å¯ï¼‰

```cpp
#include <iostream>
#include <pthread.h>
#include<unistd.h>
#include<string>
using namespace std;

pthread_t main_thread;
void* routine(void* args)
{
  int cnt=3;
  while(cnt--)
  {
    cout<<"thread"<<*(int*)args<<" id: "<<pthread_self()<<" cnt: "<<cnt<<endl;
    sleep(1);
    pthread_cancel(main_thread);//å¹²æ‰ä¸»çº¿ç¨‹
  }
    pthread_exit((void*)10);
}

int main()
{
  main_thread=pthread_self();
  pthread_t tid[5];
  for(int i=0;i<5;i++)
  {
    int* p=new int(i);
    pthread_create(tid+i,nullptr,routine,(void*)p);

  }
 sleep(2);
  for(int i=2;i<5;i++)
  {
    pthread_cancel(tid[i]);
  }
 for(int i=0;i<5;i++)
 {
    void* ret=nullptr;//åˆå§‹åŒ–ä¸€ä¸‹
    if(pthread_join(tid[i],&ret)==0)
    {
      cout<<"thread join success "<<endl;
    }
 }

  return 0;
}
```

å·¦è¾¹æ˜¯è¿è¡Œç»“æœï¼Œå³è¾¹æ˜¯ç›‘æ§è„šæœ¬

```Shell 
while :; do ps -aL |head -1 &&ps -aL |grep myproc; sleep 1; echo â€œ############â€; done
```

![image-20220805170214539](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220805170214539.png)

> éšç¬”è®°å½•ï¼šè¿›ç¨‹ä¸ºä»€ä¹ˆç‹¬ç«‹ï¼Ÿå› ä¸ºæœ‰è‡ªå·±ç‹¬ç«‹çš„åœ°å€ç©ºé—´ é¡µè¡¨ç­‰ã€‚

## ğŸŒµpthread_detach()åˆ†ç¦»çº¿ç¨‹

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ–°åˆ›å»ºçš„çº¿ç¨‹æ˜¯joinableçš„ï¼Œçº¿ç¨‹é€€å‡ºåï¼Œéœ€è¦ç”¨pthread_joinç­‰å¾…çº¿ç¨‹é‡Šæ”¾èµ„æºï¼Œå¦‚æœä¸å…³å¿ƒçº¿ç¨‹çš„è¿”å›å€¼ï¼Œjoinå°±æ˜¯ä¸€ç§è´Ÿæ‹…ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥å‘Šè¯‰ç³»ç»Ÿçº¿ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾èµ„æºã€‚å‘Šè¯‰ç³»ç»Ÿçº¿ç¨‹é€€å‡ºæ—¶çš„æ“ä½œå°±æ˜¯åˆ†ç¦»ã€‚

**åˆ†ç¦»çš„æœ¬è´¨æ˜¯è®©ä¸»çº¿ç¨‹ä¸ç”¨å†joinæ–°çº¿ç¨‹ï¼Œè®©æ–°çº¿ç¨‹é€€å‡ºçš„æ—¶å€™è‡ªåŠ¨å›æ”¶èµ„æº**

### æ¥å£ä½¿ç”¨

```c
pthread_detach - detach a thread
    
#include <pthread.h>
int pthread_detach(pthread_t thread);

Compile and link with -pthread.

```

ä¸€ä¸ªå‚æ•°ï¼šåˆ†ç¦»çš„çº¿ç¨‹ID

- ä¸€ä¸ªåˆ†ç¦»çš„çº¿ç¨‹ä¸åº”è¯¥è¢«ç­‰å¾…ï¼Œè¢«ç­‰å¾…çš„ç»“æœæ˜¯æœªå®šä¹‰çš„ï¼Œå¯èƒ½æˆåŠŸæœ‰å¯èƒ½ä¸æˆåŠŸã€‚
- çº¿ç¨‹è®¾ç½®ä¸ºåˆ†ç¦»çŠ¶æ€ï¼Œå¦‚æœè¯¥çº¿ç¨‹å´©äº†è¿›ç¨‹ä¸€æ ·ä¼šå´©ã€‚

### ğŸƒä¾‹å­

```cpp
#include <iostream>
#include <pthread.h>
#include<unistd.h>
#include<string>
using namespace std;

void* routine(void* args)
{
   pthread_t(pthread_self());
   int cnt=3;
  while(cnt--)
  {
    cout<<"new thread is running "<<endl;
    sleep(1);
  }
  return (void*)10;
}

int main()
{
  pthread_t tid;
  pthread_create(&tid,nullptr,routine,nullptr);
  while(true);//ä¸è®©ä¸»çº¿ç¨‹return 0ï¼Œä¸ç„¶è¿›ç¨‹ç›´æ¥ç»“æŸäº†
  return 0;
}
```

![image-20220805172952290](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220805172952290.png)

> linuxé‡Œä¸»çº¿ç¨‹return 0ç»“æŸçš„è¯ï¼Œä¼šè‡ªåŠ¨ç»“æŸå…¶è¿›ç¨‹ã€‚
>
> [linuxä¸‹ä¸»çº¿ç¨‹return 0å’Œpthread_exit(NULL)çš„åŒºåˆ«](https://www.cnblogs.com/Stephen-Qin/p/12730670.html#:~:text=1.å½“linuxå’ŒWindowsä¸­%2Cä¸»çº¿ç¨‹ä»¥return 0ç»“æŸæ—¶%2Cç¨‹åºä¼šåœ¨ä¸»çº¿ç¨‹è¿è¡Œå®Œæ¯•åç»“æŸ.,2.å½“linuxä¸­%2Cä¸»çº¿ç¨‹ä»¥pthread_exit (NULL)ä½œä¸ºè¿”å›å€¼%2Cåˆ™ä¸»çº¿ç¨‹ä¼šç­‰å¾…å­çº¿ç¨‹.)

# ğŸŒ²çº¿ç¨‹åŒæ­¥å’Œäº’æ–¥

## ğŸŒ´ç›¸å…³æ¦‚å¿µ

- ä¸´ç•Œèµ„æºï¼šå¤šçº¿ç¨‹æ‰§è¡Œæµå…±äº«çš„èµ„æºã€‚ï¼ˆå³å¤šä¸ªçº¿ç¨‹éƒ½èƒ½çœ‹åˆ°çš„åŒä¸€ä»½èµ„æºï¼‰

- ä¸´ç•ŒåŒºï¼šè®¿é—®ä¸´ç•Œèµ„æºçš„ä»£ç 

- äº’æ–¥ï¼šä»»ä½•æ—¶å€™ä¿è¯åªæœ‰ä¸€ä¸ªæ‰§è¡Œæµè¿›å…¥ä¸´ç•ŒåŒºè®¿é—®ä¸´ç•Œèµ„æºï¼Œå¯ä»¥ä¿æŠ¤ä¸´ç•Œèµ„æº

- åŸå­æ€§ï¼šä¸èƒ½è¢«æ‰“æ–­çš„æ“ä½œï¼Œå¯¹äºä¸€ä¸ªå…·æœ‰åŸå­æ€§çš„æ“ä½œæ¥è¯´ï¼Œè¦ä¹ˆåšäº†è¦ä¹ˆæ²¡åš

- æˆ‘ä»¬å€ŸåŠ©é”æ¥å®ç°äº’æ–¥è¿›è€Œè¾¾åˆ°ä¿æŠ¤ä¸´ç•Œèµ„æºçš„æ•ˆæœã€‚

  

## ğŸŒ´å”®ç¥¨ä¾‹å­

å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®ï¼Œé‚£å…¨å±€å˜é‡å°±æ˜¯ä¸€ä¸ªä¸´ç•Œèµ„æºï¼Œå¯¹å…¨å±€å˜é‡åšçš„ä¿®æ”¹ï¼Œå¦‚++ï¼Œ--ï¼Œå°±æœ‰é£é™©ï¼Œå› ä¸º++å’Œ--ä¸æ˜¯åŸå­æ€§çš„ã€‚ï¼ˆä»æ±‡ç¼–ä¸Šå¯ä»¥çŸ¥é“++å’Œ--éƒ½å¯¹åº”ä¸‰æ¡æ±‡ç¼–ä»£ç ï¼Œè¯´æ˜æ˜¯å¯ä»¥æ‰“æ–­çš„ï¼‰

```c
//å…¨å±€å˜é‡a++å¯¹åº”çš„ä¸‰å¥æ±‡ç¼–æŒ‡ä»¤
mov     eax, DWORD PTR a[rip]
add     eax, 1
mov     DWORD PTR a[rip], eax
```

æŠŠè¿™é‡Œçš„å…¨å±€å˜é‡aæ¢æˆå”®ç¥¨æ—¶çš„ç¥¨ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

**ä¸‹é¢åˆ›å»ºäº”ä¸ªçº¿ç¨‹æ¨¡æ‹ŸæŠ¢ç¥¨æ—¶çš„åœºæ™¯ã€‚**

> ç¥¨æ•°++éœ€è¦ç»è¿‡ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼šticketsä»å†…å­˜å†™å…¥å¯„å­˜å™¨ï¼ŒCPUå¯¹å¯„å­˜å™¨é‡Œçš„ticketsè¿ç®—ï¼Œç®—å¥½çš„ç»“æœå†å†™å›å†…å­˜ï¼Œè¿™ä¸‰æ­¥éƒ½å¯èƒ½è¢«ä¸­æ–­ï¼Œæ‰€ä»¥è®¿é—®ticketsè¿™ä¸ªä¸´ç•Œèµ„æºæ˜¯ä¸å®‰å…¨çš„ã€‚
>
> ä¸‹é¢å¯„å­˜å™¨å’ŒCPUä¹‹é—´çš„ç®­å¤´è¡¨ç¤ºçš„æ˜¯è¿ç®—ï¼Œä¸ä»£è¡¨æ•°æ®çš„æ‹·è´ã€‚
>
> ![image-20220805231808907](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220805231808907.png)
>
> å¦‚æœticketsæ˜¯1ï¼ŒCPUç®—å®Œååœ¨å†™å›å†…å­˜è¿™ä¸€æ­¥è¢«æ‰“æ–­äº†ï¼Œç„¶åå¯„å­˜å™¨2ç›¸å…³çš„çº¿ç¨‹è¿›æ¥ï¼ŒæŠŠticketsæ”¹æˆäº†999ï¼Œåˆ«çš„çº¿ç¨‹å†çœ‹ticketsæœ¬æ¥åº”è¯¥æ˜¯0çš„å´è¢«å†™æˆäº†999ï¼Œå°±å‡ºç°äº†é—®é¢˜ã€‚

```c++
#include <iostream>
#include <pthread.h>
#include<unistd.h>
#include<string>
using namespace std;

int tickets=100 ;//ä¸´ç•Œèµ„æº
void* routine(void* args)
{
  while(1)
  {
    if(tickets>0)
    {
      usleep(30000);//åŸå› åœ¨è¿™
      printf("thread 0x%x: get a ticket %d\n",pthread_self(),tickets);
      tickets--;
    }
    else 
    {
      break;
    }
  }
  printf("thread 0x%xquit! ticket %d\n",pthread_self(),tickets);
  return (void*)10;
}

#define NUM 5
int main()
{
  pthread_t tid[NUM];
  for(int i=0;i<NUM;i++)
  {
    pthread_create(tid+i,nullptr,routine,nullptr);
  }

  for(int i=0;i<NUM;i++)
  {
    pthread_join(tid[i],nullptr);
  }
  return 0;
}
```

![image-20220805224031925](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220805224031925.png)

å‡ºç°äº†**è´Ÿæ•°**ï¼Œæ˜¾ç„¶ä¸åˆç†ã€‚è¿™å°±æ˜¯**å…¸å‹çš„å¤šçº¿ç¨‹åˆ‡æ¢çš„æ—¶å€™å› ä¸ºæ•°æ®äº¤å‰æ“ä½œå¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜**ã€‚OSåœ¨å†…æ ¸æ€è¿”å›ç”¨æˆ·æ€çš„æ—¶å€™è¿›è¡Œçº¿ç¨‹åˆ‡æ¢ã€‚è¿™ç§ç°è±¡çš„æœ¬è´¨æ˜¯ticket--ä¸æ˜¯åŸå­æ€§çš„ã€‚

æœ¬è´¨å°±æ˜¯å¤šä¸ªæ‰§è¡Œæµè¿›å…¥äº†ifè¯­å¥ã€‚

> å…·ä½“åŸå› æ˜¯å› ä¸ºæŠ¢ç¥¨å‰ç¡äº†ä¸€ä¸‹ï¼Œç³»ç»Ÿå°±åˆ‡åˆ°åˆ«çš„çº¿ç¨‹äº†ï¼Œç„¶ååˆ«çš„çº¿ç¨‹æŠ¢å®Œç¥¨åç¥¨æ•°å·²ç»å°äº0äº†ï¼Œæ­¤æ—¶åˆšæ‰ç¡çš„çº¿ç¨‹é†’äº†è¿‡æ¥åˆæŠ¢ï¼Œè‡ªç„¶å°±æ˜¯è´Ÿæ•°äº†ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œçº¿ç¨‹1è¿›å…¥äº†ifè¯­å¥å¼€å§‹äº†ç¡çœ ï¼Œåˆ‡åˆ°äº†çº¿ç¨‹2,2å»æŠ¢ç¥¨ï¼ŒæŠ¢å®Œåç¥¨æ•°å°äº0ï¼Œçº¿ç¨‹1è‹é†’ï¼Œæ­¤æ—¶çº¿ç¨‹1å·²ç»åœ¨ifè¯­å¥é‡Œé¢ï¼Œå†å»æŠ¢ç¥¨ç¥¨æ•°å°±æ˜¯è´Ÿæ•°äº†ã€‚

## ğŸŒ´äº’æ–¥é‡pthread_mutex_t

ä¸ºäº†è§£å†³è¿™ç§æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥äº†é”ã€‚ä¸‹é¢å€ŸåŠ©é”æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå…¶å®å°±æ˜¯ä¿è¯ä¸€æ¬¡åªæœ‰ä¸€ä¸ªæ‰§è¡Œæµè®¿é—®ä¸´ç•ŒåŒºã€‚

åœ¨linuxé‡Œè¿™æŠŠé”å°±å«äº’æ–¥é‡ã€‚ä¸‹é¢ä¸»è¦æ˜¯é”çš„ä½¿ç”¨ã€‚

å¯ä»¥æŠŠä¸´ç•ŒåŒºæ¯”ä½œä¸€ä¸ªæˆ¿é—´ï¼Œä¸€ä¸ªäººï¼ˆæ‰§è¡Œæµï¼‰è¿›äº†ä¸´ç•ŒåŒºå°±ä¸Šé”ï¼Œé‚£åˆ«çš„äººéƒ½ä¸èƒ½è¿›æ¥äº†ï¼Œæ­¤æ—¶åªæœ‰è¿™ä¸€ä¸ªäººå¯ä»¥è®¿é—®ä¸´ç•Œèµ„æºï¼Œå…¶ä½™äººï¼ˆæ‰§è¡Œæµï¼‰å…¨åœ¨é—¨å¤–ç­‰ç€è§£é”ã€‚ç”¨é”çš„ä»£ä»·å¾ˆå¤§ï¼Œæ‰€ä»¥ä¸Šé”å’Œè§£é”çš„æ–¹å¼å°±æŒºæœ‰è®²ç©¶çš„ã€‚

~~åœ¨å†…æ ¸é‡Œæ‰¾äº’æ–¥é‡çš„æ—¶å€™å‘ç°pthread_mutex_tè¢«å°è£…è¿‡äº†ï¼Œä¸å¤ªå¥½æ‰¾~~

### ğŸŒµpthread_mutex_initå’Œpthread_mutex_destroy

é”ä½¿ç”¨å‰å…ˆè¦åˆå§‹åŒ–ï¼Œç”¨å®Œä¹Ÿè¦é”€æ¯ã€‚

```c
pthread_mutex_destroy, pthread_mutex_init - destroy and initialize a mutex

#include <pthread.h>
int pthread_mutex_destroy(pthread_mutex_t *mutex);
int pthread_mutex_init(pthread_mutex_t *restrict mutex,
                       const pthread_mutexattr_t *restrict attr);
pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;
```

pthread_mutex_initçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªäº’æ–¥é‡çš„æŒ‡é’ˆï¼Œç¬¬äºŒä¸ªå‚æ•°attrè¡¨ç¤ºå±æ€§ï¼Œä¼ NULLè¡¨ç¤ºé»˜è®¤çš„å±æ€§ã€‚æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›é”™è¯¯ç ã€‚

pthread_mutex_initçš„å‚æ•°æ˜¯ä¸€ä¸ªäº’æ–¥é‡çš„æŒ‡é’ˆï¼ŒæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›é”™è¯¯ç ã€‚

æ­¤å¤–ï¼Œé™¤äº†ç”¨pthread_mutex_initè¿›è¡ŒåŠ¨æ€åˆ†é…çš„åˆå§‹åŒ–ï¼Œè¿˜æœ‰ä¸€ç§é™æ€åˆ†é…çš„æ–¹æ³•ï¼šã€

```c
pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;//PTHREAD_MUTEX_INITIALIZERæœ¬è´¨æ˜¯ä¸€ä¸ªå®
```

> éšç¬”è®°å½•ï¼šçº¿ç¨‹Açš„æ—¶é—´ç‰‡åˆ°äº†ï¼ŒCPUçš„å¯„å­˜å™¨é‡Œè¿˜æœ‰æ•°æ®ï¼Œè¿™éƒ¨åˆ†æ•°æ®å°±ç§°ä½œä¸Šä¸‹æ–‡æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä¸´æ—¶æ•°æ®
>
> å¯„å­˜å™¨æ˜¯çº¿ç¨‹å…±äº«çš„ï¼Œæ•°æ®æ˜¯ç§æœ‰çš„ã€‚

### ğŸŒµpthread_mutex_lockå’Œpthread_mutex_unlock

ä¸Šé”å’Œè§£é”

```c
pthread_mutex_lock, pthread_mutex_trylock, pthread_mutex_unlock - lock and unlock a mutex

#include <pthread.h>

int pthread_mutex_lock(pthread_mutex_t *mutex);
int pthread_mutex_trylock(pthread_mutex_t *mutex);
int pthread_mutex_unlock(pthread_mutex_t *mutex)
```

> å…³äº pthread_mutex_trylockä¼šå°è¯•å¯¹äº’æ–¥é‡åŠ é”ï¼Œå¦‚æœäº’æ–¥é‡å·²ç»ä¸Šé”äº†ã€‚å‡½æ•°è°ƒç”¨å¤±è´¥ï¼Œå¦åˆ™è°ƒç”¨æˆåŠŸè¿”å›0

### ğŸ¥è§£å†³ç¥¨æ•°ä¸ºè´Ÿæ•°çš„é—®é¢˜

```c++
#include <iostream>
#include <pthread.h>
#include<unistd.h>
#include<string>
using namespace std;

pthread_mutex_t lock;
int tickets=100 ;
void* routine(void* args)
{
  while(1)
  { 
    pthread_mutex_lock(&lock);
    if(tickets>0)
    {
      usleep(30000);
      printf("thread 0x%x: get a ticket %d\n",pthread_self(),tickets);
      tickets--;
      pthread_mutex_unlock(&lock);
    }
    else 
    {
      pthread_mutex_unlock(&lock);//è¿™å¿…é¡»è§£é”ï¼Œä¸ç„¶çš„è¯å¯èƒ½ä¸Šäº†é”æ²¡è§£é”ï¼Œå¯¼è‡´è‡ªå·±ä¸€ç›´æ‹¿ç€è¿™æŠŠé”å¯¼è‡´é˜»å¡
      break;
    }
  }
  printf("thread 0x%x quit! ticket %d\n",pthread_self(),tickets);
  return (void*)10;
}

#define NUM 5
int main()
{
  pthread_mutex_init(&lock,nullptr);
  pthread_t tid[NUM];
  for(int i=0;i<NUM;i++)
  {
    pthread_create(tid+i,nullptr,routine,nullptr);
  }

  for(int i=0;i<NUM;i++)
  {
    pthread_join(tid[i],nullptr);
  }
  pthread_mutex_destroy(&lock);
  return 0;
}
```

![image-20220806000248536](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220806000248536.png)

è¿™ç§åšæ³•åˆè¡ç”Ÿå‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼Œä¸€ç›´éƒ½æ˜¯ä¸€ä¸ªäººåœ¨ä¹°ç¥¨ã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜éœ€è¦åœ¨æŠ¢å®Œç¥¨åè®©è¿™ä¸ªçº¿ç¨‹ä¼‘æ¯ä¸€ä¼šï¼Œæ¯”å¦‚ç¡ä¸€ä¼šåšç‚¹åˆ«çš„å·¥ä½œä¹‹ç±»çš„ï¼Œåˆ«çš„è¿›ç¨‹æ‰æœ‰å¯èƒ½è¿›æ¥æŠ¢ç¥¨ã€‚

### ğŸ¥ç›¸å…³æ¦‚å¿µè¡¥å……

- é”çš„å­˜åœ¨æ˜¯ä¸ºäº†ä¿æŠ¤ä¸´ç•Œèµ„æº

- é”çš„æœ¬èº«å°±æ˜¯ä¸€ç§ä¸´ç•Œèµ„æºï¼ˆå¤§å®¶éƒ½èƒ½ç”³è¯·é”ï¼‰ï¼Œé‚£è°æ¥ä¿æŠ¤é”ï¼Ÿåªéœ€ä¿è¯lockå’Œunlockæ˜¯åŸå­çš„å³å¯ã€‚
- ä¸€ä¸ªçº¿ç¨‹ä¸Šäº†é”ï¼Œåˆ«çš„çº¿ç¨‹ä¹Ÿèƒ½ç»§ç»­ç”³è¯·è¿™æŠŠé”ï¼Œåªä¸è¿‡æ— æ³•ç”³è¯·æˆåŠŸã€‚
- ä¸Šäº†é”ä¹Ÿä¼šå‘ç”Ÿçº¿ç¨‹åˆ‡æ¢ï¼Œä½†æ˜¯åˆ‡æ¢åçš„é”èµ„æºä¼šåœ¨pthread_mutex_lockè¿™é˜»å¡ä½ï¼ˆæŒ‚èµ·ï¼‰ï¼Œç›´åˆ°é”è¢«è§£å¼€ã€‚

## ğŸŒ´äº’æ–¥é‡ï¼ˆé”ï¼‰çš„åŸç†

é”çš„ä½¿ç”¨

![image-20220806001458788](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220806001458788.png)

é”çš„åŸç†ï¼šç®€å•æ¦‚æ‹¬ä¸º01ä¸¤ç§çŠ¶æ€

å†™æ®µä¼ªä»£ç ç†è§£ä¸€ä¸‹

```c
lock:
	movb $0,%al
	xchgb %al,mutex//xchgbæ˜¯ä¸€æ¡äº¤æ¢æŒ‡ä»¤ï¼Œç­‰åŒäºswap
	if(alå¯„å­˜å™¨å†…å®¹>0)
    {
        return 0;
    }        
	else
    {
        æŒ‚èµ·ç­‰å¾…;
    }        
	goto lock;
unlock:
	movb $1,mutex
	å”¤é†’ç­‰å¾…mutexçš„çº¿ç¨‹
	return 0;        
```

![image-20220806005113265](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220806005113265.png)

mutexä¸º1æ—¶è¡¨ç¤ºå¯ä»¥ç”³è¯·é”æˆåŠŸï¼Œå½“mutexä¸º1æ—¶:

![image-20220806005302871](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220806005302871.png)

å½“mutexä¸º0æ—¶:

![image-20220806005443504](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220806005443504.png)

- è§£é”ä¹Ÿå¥½ç†è§£ï¼ŒæŠŠmutexç½®ä¸º1ï¼Œä¸‹æ¬¡å°±èƒ½ç”³è¯·æˆåŠŸäº†ï¼Œå†å”¤é†’å…¶ä»–åœ¨ç­‰å¾…çš„çº¿ç¨‹å°±è¡Œäº†ã€‚

- å¯ä»¥çœ‹åˆ°åªæœ‰ä¸€ä¸ª1ï¼Œè¿™ä¸ª1è¢«æ‹¿èµ°ååªæœ‰è§£é”çš„æ—¶å€™æ‰ä¼šè¿˜å›æ¥ï¼Œåˆ«çš„çº¿ç¨‹åœ¨è¿™æœŸé—´éƒ½æ˜¯æ‹¿ä¸åˆ°1çš„

## ğŸŒ´æ­»é”

ä¸€ç»„è¿›ç¨‹ä¸­çš„å„ä¸ªè¿›ç¨‹å‡å æœ‰ä¸ä¼šé‡Šæ”¾çš„èµ„æºï¼Œåˆå› ä¸ºç›¸äº’ç”³è¯·è¢«å…¶ä»–è¿›ç¨‹å ç”¨æ‰€ä¸ä¼šé‡Šæ”¾çš„èµ„æºè€Œå¤„äºçš„ä¸€ç§æ°¸ä¹…ç­‰å¾…çŠ¶æ€ã€‚

ç®€å•æ¥è¯´ï¼Œè‡ªå·±æ‰‹é‡Œçš„ä¸é‡Šæ”¾ï¼Œåˆè¦åˆ«äººæ‰‹é‡Œçš„ï¼Œåˆ«äººæ‰‹é‡Œçš„ä¹Ÿä¸é‡Šæ”¾ï¼Œä¸¤ä¸ªäººå°±åœ¨è¿™åƒµç€ã€‚ä¹Ÿå°±æ˜¯å¤šä¸ªè¿›ç¨‹å†è¿è¡Œè¿‡ç¨‹ä¸­äº‰å¤ºèµ„æºé€ æˆçš„ä¸€ç§åƒµå±€ã€‚

å¥—å…¥æŸç§å…·ä½“æƒ…å†µå°±æ˜¯ï¼šè¯·æ±‚ä½ çš„é”ï¼Œåˆä¸é‡Šæ”¾è‡ªå·±çš„é”ã€‚

> æˆ‘å¯ä»¥å’Œä½ è€—ä¸€æ•´å¤©ã€‚--ç¾é˜Ÿ

### ğŸ¥æ­»é”äº§ç”Ÿçš„æ¡ä»¶

äº’æ–¥æ¡ä»¶ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªæ‰§è¡Œæµä½¿ç”¨

è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šä¸€ä¸ªæ‰§è¡Œæµå› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾

ä¸å‰¥å¤ºæ¡ä»¶ï¼šä¸€ä¸ªæ‰§è¡Œæµå·²è·å¾—çš„èµ„æºï¼Œåœ¨æœªä½¿ç”¨ä¹‹å‰ï¼Œä¸èƒ½å¼ºè¡Œå‰¥å¤º

å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šè‹¥å¹²æ‰§è¡Œæµä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºçš„å…³ç³»ã€‚

> ä¸€ä¸ªèµ„æºåªèƒ½ä¸€æ¬¡è¢«ä¸€ä¸ªæ‰§è¡Œæµä½¿ç”¨ï¼Œå·²è·å¾—çš„èµ„æºä¸èƒ½å¼ºè¡Œå‰¥å¤ºï¼ŒåŒæ—¶ç”³è¯·åˆ«çš„èµ„æºé˜»å¡æ—¶åˆä¸æ”¾å¼ƒè‡ªå·±çš„èµ„æºï¼Œè‹¥å¹²æ‰§è¡Œæµä¹‹é—´æœ‰å¾ªç¯ç­‰å¾…çš„å…³ç³»

### ğŸ¥é¿å…æ­»é”

- ç ´åæ­»é”äº§ç”Ÿçš„æ¡ä»¶

- åŠ é”é¡ºåºä¸€è‡´ï¼ˆæ¯”å¦‚é”1å’Œé”2ï¼Œçº¿ç¨‹1å…ˆä¸Šé”1å†ä¸Šé”2ï¼Œçº¿ç¨‹2å…ˆä¸Šé”2å†ä¸Šé”1ï¼Œå°±å¯èƒ½å¯¼è‡´çº¿ç¨‹1æ‹¿ç€é”1å»ç”³è¯·é”2ï¼Œæ­¤æ—¶çº¿ç¨‹2æ‹¿ç€é”2å»ç”³è¯·é”1ï¼Œä¸¤ä¸ªäººéƒ½åœ¨é‚£ç­‰ï¼Œç»“æœå°±æ­»é”äº†ï¼‰
- é¿å…é”æœªé‡Šæ”¾ï¼ˆé¿å…æœ‰äººä¸€ç›´æ‹¿ç€é”ä¸æ”¾ï¼‰
- èµ„æºä¸€æ¬¡æ€§åˆ†é…ï¼ˆä¸€æ¬¡æ€§æŠŠèµ„æºéƒ½åˆ†é…å¥½äº†ï¼Œå°±ä¸ä¼šå»è¯·æ±‚åˆ«äººçš„èµ„æºäº†ï¼‰

> é¿å…æ­»é”çš„ç®—æ³•ï¼šæ­»é”æ£€æµ‹ç®—æ³•å’Œé“¶è¡Œå®¶ç®—æ³•ã€‚ï¼ˆå¾…äº†è§£
>
> æ¨¡æ‹Ÿæ­»é”çš„æ€è·¯:ä¸¤ä¸ªçº¿ç¨‹,çº¿ç¨‹aç”³è¯·é”a,çº¿ç¨‹bæ‹¿åˆ°é”b,æ‹¿åˆ°åè®©ä¸¤ä¸ªçº¿ç¨‹ç¡ä¸€ä¸‹,ä¿è¯ä¸ä¼šå‡ºç°æ—¶åºé—®é¢˜,èåˆè®©çº¿ç¨‹aç”³è¯·é”bçº¿ç¨‹bç”³è¯·é”a,è¿™æ ·æ»¡è¶³å¾ªç¯ç­‰å¾…å°±æ­»é”äº†

## ğŸŒ´åŒæ­¥

> ä¸Šé¢è®²äº†åŠ é”ä¿æŒäº’æ–¥ï¼Œä¸‹é¢æçš„å°±æ˜¯åŒæ­¥ã€‚

ä¿è¯æ•°æ®å®‰å…¨çš„å‰æä¸‹è®©æ‰§è¡Œæµä»¥æŸç§ç‰¹å®šçš„é¡ºåºå»è®¿é—®èµ„æºã€‚

ä»æ‰§è¡Œæµçš„æ‰§è¡Œé¡ºåºçš„è§’åº¦çœ‹ï¼ŒåŒæ­¥æ˜¯ä¸€ç§æ›´ä¸ºå¤æ‚çš„äº’æ–¥ï¼Œäº’æ–¥æ˜¯å¤šä¸ªæ‰§è¡Œæµç›´æ¥ä¸å¯ä»¥åŒæ—¶è®¿é—®ä¸€å—ä¸´ç•Œèµ„æºï¼Œä»–ä»¬äº’ç›¸æ’æ–¥ï¼Œæ¯”å¦‚ä¸€ä¸ªè®¿é—®å®Œäº†å¦ä¸€ä¸ªå†è®¿é—®ã€‚åŒæ­¥åˆ™æ›´ä¸ºç‰¹æ®Šï¼ŒåŒæ­¥æ˜¯ä»¥ä¸€ç§ç‰¹å®šçš„é¡ºåºå®‰æ’å¤šä¸ªæ‰§è¡Œæµè®¿é—®ä¸€å—èµ„æºã€‚

### ğŸ¥åŒæ­¥çš„å¿…è¦æ€§

ä»¥ç‰¹å®šçš„é¡ºåºè®¿é—®èµ„æºï¼Œæœ‰æ•ˆé¿å…äº†"é¥¥é¥¿é—®é¢˜"ã€‚

ä»¥æŠ¢ç¥¨ä¸ºä¾‹ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹é”çš„ç«äº‰èƒ½åŠ›å¾ˆå¼ºï¼Œå¯¼è‡´åˆ«çš„çº¿ç¨‹éƒ½æŠ¢ä¸åˆ°ç¥¨ï¼Œè¿™æœ‰é”™å—ï¼Ÿæ²¡æœ‰é”™ï¼Œä½†æ˜¯ä¸åˆç†ã€‚

å†ä»¥å»è‡ªä¹ å®¤ä¸ºä¾‹ï¼Œä¸€ä¸ªè‡ªä¹ å®¤æ¯æ¬¡åªèƒ½å®¹çº³ä¸€ä¸ªäººï¼Œä¸€ä¸ªäººè¿›å»å­¦å®Œäº†å‡ºæ¥åå‘ç°å¤–é¢æ’äº†å¾ˆé•¿çš„é˜Ÿç­‰ç€è¿›æ¥ï¼Œç»“æœä»–åˆšè§£é”å‡ºé—¨ä¸€æƒ³è¦ä¸æˆ‘å†å­¦ä¸€ä¸‹å§ï¼Œåˆå¼€é—¨è¿›å»äº†ï¼Œå¤–é¢çš„äººç»§ç»­åœ¨å¤–é¢ç­‰ï¼Œå¯¼è‡´è‡ªä¹ å®¤ä¸€ç›´å°±æ˜¯è¿™ä¸€ä¸ªäººè‡ªä¹ ï¼Œæ²¡æœ‰é”™ä½†ä¸åˆç†ã€‚åŒæ­¥è§£å†³çš„å°±æ˜¯è¿™ç§é—®é¢˜ï¼ŒæŠ¢ç¥¨é‚£å°±ä½ æŠ¢å®Œç„¶åä¸‹ä¸€ä¸ªäººå»æŠ¢ï¼Œè‡ªä¹ å®¤ä½ å‡ºæ¥äº†é©¬ä¸Šåˆ°æ’é˜Ÿé˜Ÿä¼åé¢å»ï¼Œè¦æƒ³å†è¿›æ¥å°±è¦ç­‰å‰é¢äººéƒ½è‡ªä¹ å®Œäº†ã€‚

> ç«äº‰äº§ç”Ÿçš„åŸå› æ˜¯å› ä¸ºæˆ‘ä»¬çš„æ“ä½œä¸æ˜¯åŸå­çš„ã€‚
>
> æ’é˜Ÿçš„æœ¬è´¨ï¼šåœ¨å®‰å…¨çš„å‰æä¸‹è·å–é”ï¼ŒæŒ‰ç…§æŸç§é¡ºåºè¿›è¡Œç”³è¯·å’Œé‡Šæ”¾ï¼Œè¿™å°±æ˜¯åŒæ­¥çš„è¿‡ç¨‹

åŒæ­¥è§£å†³äº†èµ„æºåˆ†é…ä¸åˆç†çš„é—®é¢˜ï¼Œè®©çº¿ç¨‹æœ‰åºçš„ç”³è¯·é”ã€‚

## ğŸŒ´æ¡ä»¶å˜é‡

> [æ·±å…¥è§£ææ¡ä»¶å˜é‡(condition variables) ](https://www.cnblogs.com/harlanc/p/8596211.html)

æ¡ä»¶å˜é‡æ˜¯çº¿ç¨‹åº“æä¾›çš„ä¸€ä¸ªæè¿°ä¸´ç•Œèµ„æºçš„å¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ªå˜é‡ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œæœ‰ä¸¤ä¸ªäººAå’ŒBè’™ç€çœ¼ï¼Œä¸€ä¸ªäººå¾€ç›’å­é‡Œæ”¾è‹¹æœï¼Œä¸€ä¸ªäººå»ç›’å­é‡Œæ‹¿è‹¹æœï¼Œä»–ä»¬éƒ½ä¸çŸ¥é“å¯¹æ–¹å¯¹æ–¹åšåˆ°å“ªä¸€æ­¥äº†ï¼Œæ¯”å¦‚Aä¸çŸ¥é“Bæ”¾æ²¡æ”¾è¿›å»ï¼Œåªèƒ½ä¸€ç›´ä¼¸æ‰‹å»è¯•ï¼Œä¹Ÿå°±æ˜¯å»æ£€æµ‹ç›’å­é‡Œæœ‰æ²¡æœ‰è‹¹æœï¼Œè¿™å°±æ˜¯è½®è¯¢æ£€æµ‹ï¼Œè‹¹æœå°±æ˜¯ä¸´ç•Œèµ„æºï¼ŒAå’ŒBå°±æ˜¯ä¸¤ä¸ªçº¿ç¨‹ã€‚

Aåœ¨æ‹¿è‹¹æœæ—¶ï¼ŒBæœ‰ä¸‰ç§çŠ¶æ€ï¼Œæ”¾å‰ï¼Œæ”¾ä¸­ï¼Œæ”¾åã€‚æ”¾ä¸­çš„çŠ¶æ€æ˜¯ä¸ç¡®å®šçš„æ‰€ä»¥éœ€è¦æ‹¿è‹¹æœçš„äººè½®è¯¢æ£€æµ‹ã€‚æ£€æµ‹è¿™ä¸ªæ“ä½œæœ¬èº«å°±éœ€è¦èµ„æºã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨Bæ”¾å®Œè‹¹æœåæ‘‡ä¸€ä¸‹é“ƒé“›å‘Šè¯‰Aæˆ‘æ”¾å¥½è‹¹æœäº†ï¼Œä½ æ¥æ‹¿å§ï¼Œè¿™ä¸ªé“ƒé“›å°±æ˜¯æ¡ä»¶å˜é‡ã€‚æ£€æµ‹çš„æœ¬è´¨å°±æ˜¯æˆ‘ä»¬ä¸çŸ¥é“ä¸´ç•Œèµ„æºçš„æƒ…å†µï¼Œä½†éœ€è¦æˆ‘ä»¬é€šè¿‡æŸç§æ‰‹æ®µçŸ¥é“ã€‚

![image-20220807145755487](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220807145755487.png)

**æ¡ä»¶å˜é‡ä½¿å¾—ä¸ç”¨é¢‘ç¹é€šè¿‡ç”³è¯·å’Œé‡Šæ”¾é”çš„æ–¹å¼ï¼Œä¹Ÿèƒ½è¾¾åˆ°æ£€æµ‹ä¸´ç•Œèµ„æºçš„ç›®çš„ã€‚**

### ğŸŒµpthread_cond_initå’Œpthread_cond_destroy

å’Œé”çš„åˆå§‹åŒ–å¾ˆåƒ

```c
pthread_cond_destroy, pthread_cond_init - destroy and initialize condition variables
     
#include <pthread.h>
int pthread_cond_destroy(pthread_cond_t *cond);
int pthread_cond_init(pthread_cond_t *restrict cond,
                      const pthread_condattr_t *restrict attr);
pthread_cond_t cond = PTHREAD_COND_INITIALIZER;

```

> pthread_cond_tç±»å‹ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªç»“æ„ä½“ã€‚å¯ç®€å•çœ‹ä¸ºæœ‰ä¸¤ç§å–å€¼0å’Œ1ï¼Œå³æ»¡è¶³æ¡ä»¶å’Œä¸æ»¡è¶³æ¡ä»¶

pthread_cond_initåˆå§‹åŒ–ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œpthread_cond_destroyé”€æ¯ä¸€ä¸ªæ¡ä»¶å˜é‡ã€‚

pthread_cond_initçš„ç¬¬ä¸€ä¸ªå‚æ•°condæ˜¯æ¡ä»¶å˜é‡ç±»å‹çš„æŒ‡é’ˆï¼Œç¬¬äºŒä¸ªå‚æ•°attrè¡¨ç¤ºå±æ€§ï¼Œä¼ å…¥NULLè¡¨ç¤ºä½¿ç”¨é»˜è®¤å±æ€§ã€‚æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›é”™è¯¯ç ã€‚

pthread_cond_destroyçš„å‚æ•°condæ˜¯æ¡ä»¶å˜é‡ç±»å‹çš„æŒ‡é’ˆã€‚æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›é”™è¯¯ç ã€‚

è°ƒç”¨pthread_cond_initæ˜¯åŠ¨æ€åˆå§‹åŒ–ï¼Œè¿˜æœ‰ä¸€ç§é™æ€åˆå§‹åŒ–çš„æ–¹å¼:

```c
pthread_cond_t cond = PTHREAD_COND_INITIALIZER;
```

### ğŸŒµpthread_cond_wait

è®©çº¿ç¨‹åœ¨condæ¡ä»¶å˜é‡ä¸‹ç­‰å¾…

```c
pthread_cond_timedwait, pthread_cond_wait - wait on a condition
#include <pthread.h>

int pthread_cond_timedwait(pthread_cond_t *restrict cond,
                               pthread_mutex_t *restrict mutex,
                               const struct timespec *restrict abstime);
int pthread_cond_wait(pthread_cond_t *restrict cond,
                      pthread_mutex_t *restrict mutex);
```

pthread_cond_waité˜»å¡ç­‰å¾…ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œpthread_cond_timedwaité™æ—¶ç­‰å¾…ä¸€ä¸ªæ¡ä»¶å˜é‡ã€‚

pthread_cond_waitç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¦ç­‰çš„æ¡ä»¶å˜é‡çš„æŒ‡é’ˆï¼Œmutexè¡¨ç¤ºå½“å‰çº¿ç¨‹æ‰€å¤„ä¸´ç•ŒåŒºå¯¹åº”çš„äº’æ–¥é”ã€‚

pthread_cond_timedwaitå‰ä¸¤ä¸ªå‚æ•°å’Œpthread_cond_waitç›¸åŒï¼Œç¬¬ä¸‰ä¸ªå‚æ•°è¡¨ç¤ºæ—¶é—´ã€‚

> - ç­‰å¾…çš„çº¿ç¨‹ä¸æ­¢ä¸€ä¸ªï¼Œæ‰€ä»¥è‚¯å®šæ˜¯æœ‰**ç­‰å¾…é˜Ÿåˆ—**çš„ï¼Œæ‰€ä»¥æ¡ä»¶å˜é‡çš„å®ç°å’Œé˜Ÿåˆ—åº”è¯¥ç›¸å…³ï¼ŒçŒœçš„ã€‚
> - ä¸ºä»€ä¹ˆpthread_cond_waitè¦ä¼ å…¥é”å‚æ•°ï¼Ÿ
>
> 1. æ¡ä»¶å˜é‡ä¸ä¼šæ— ç¼˜æ— æ•…çš„æ»¡è¶³ï¼Œæ‰€ä»¥è‚¯å®šè¦ä¸€ä¸ªå‚æ•°é€šè¿‡æŸäº›æ“ä½œæ¥æ”¹å˜å…±äº«å˜é‡æ»¡è¶³æ¡ä»¶ï¼Œä¼šç‰µæ‰¯åˆ°å…±äº«æ•°æ®ï¼ˆä¸´ç•Œèµ„æºï¼‰çš„å˜åŒ–ï¼Œæ‰€ä»¥è¦åŠ é”ã€‚ï¼ˆå¦‚æœå¤§å®¶éƒ½çœ‹åˆ°åŒä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œé‚£æ¡ä»¶å˜é‡æœ¬èº«å°±æ˜¯ä¸€ä¸ªä¸´ç•Œèµ„æºï¼‰
> 2. åœ¨æ¡ä»¶å˜é‡ä¸‹ç­‰å¾…çš„çº¿ç¨‹å¯èƒ½åœ¨ä¸´ç•ŒåŒºï¼Œæ‰€ä»¥**é˜»å¡è‡ªå·±ï¼ˆç­‰å¾…ï¼‰çš„åŒæ—¶é‡Šæ”¾é”ï¼Œè¢«å”¤é†’åé‡æ–°è·å–é”**ï¼Œè¿™æ ·æ‰èƒ½ä¿æŠ¤ä¸´ç•Œèµ„æºã€‚
>
> æ‰€ä»¥waitå’Œsignalæ“ä½œæ˜¯ä¼šæ¶‰åŠåˆ°é”çš„,è¿™é‡Œä¹Ÿå¯¼è‡´äº†ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹é‡Œé¢ä¸€ä¸ªå¾ˆç»å…¸çš„é—®é¢˜:ä¸ºä»€ä¹ˆåˆ¤æ–­çš„æ¡ä»¶è¦ç”¨whileè€Œä¸èƒ½ç”¨if?
>
> å› ä¸ºwaitä¼šé‡Šæ”¾é”,æ­¤æ—¶æœ‰å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€ä¸ªåœ°æ–¹ç­‰å¾…,å¦‚æœä½¿ç”¨pthread_cond_broadcastå”¤é†’å¤šä¸ªçº¿ç¨‹,å”¤é†’ä»–ä»¬åä»–ä»¬éƒ½å»ç«äº‰é”,åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‹¿åˆ°é”,è¿™ä¸ªçº¿ç¨‹åšå®Œäº†è‡ªå·±çš„äº‹æƒ…å,åˆ«çš„çº¿ç¨‹éƒ½æ˜¯é†’ç€çš„,æ˜¯å¯ä»¥å¾€ä¸‹æ‰§è¡Œçš„,æœ¬æ¥ä¸åº”è¯¥é†’çš„æ­¤æ—¶é†’äº†è¿˜å¤„ç†äº†æ•°æ®æ‰€ä»¥å°±ä¼šå‡ºé—®é¢˜,è¿™ä¸ªé—®é¢˜æ¶‰åŠåˆ°çš„ä¸¤ä¸ªæ¦‚å¿µ,ä¸€ä¸ªæ˜¯æƒŠç¾¤ç°è±¡,ä¸€ä¸ªæ˜¯ä¼ªå”¤é†’

### ğŸŒµpthread_cond_signalå’Œpthread_cond_broadcast

```c
pthread_cond_broadcast, pthread_cond_signal - broadcast or signal a condition

#include <pthread.h>

int pthread_cond_broadcast(pthread_cond_t *cond);
int pthread_cond_signal(pthread_cond_t *cond);
```

å”¤é†’åœ¨condæ¡ä»¶å˜é‡ä¸‹ç­‰å¾…çš„çº¿ç¨‹ã€‚

pthread_cond_signalå”¤é†’ä¸€ä¸ªæ¡ä»¶å˜é‡ä¸ºcondçš„çº¿ç¨‹ï¼Œpthread_cond_broadcastå”¤é†’æ‰€æœ‰æ¡ä»¶å˜é‡ä¸ºcondçš„çº¿ç¨‹ã€‚æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›é”™è¯¯ç ã€‚

### ğŸ”¥ä¾‹å­

çº¿ç¨‹0æ§åˆ¶å…¶ä½™å‡ ä¸ªçº¿ç¨‹ï¼Œè®©ä»–ä»¬æœ‰åºè¿›è¡Œã€‚

```c
#include <iostream>
#include <pthread.h>
#include<unistd.h>
#include<string>
using namespace std;

pthread_mutex_t lock;
pthread_cond_t cond;
void* routine2(void* args)//è¢«æ§åˆ¶çš„çº¿ç¨‹
{
  printf("thread %d start\n",*((int*)args));
  while(1)
  {
    pthread_cond_wait(&cond,&lock);
    printf("thread %d is running\n",*((int*)args));//è¦å¤„ç†çš„å·¥ä½œæ•°æ®ç­‰
    sleep(1);
  }
}
void* routine1(void* args)//æ§åˆ¶çº¿ç¨‹
{
  while(1)
  {
    pthread_cond_signal(&cond);//å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œå³æ‘‡é“ƒé“›
    printf("i am ctrl thread %d   ",*((int*)args));
    sleep(1);
  }
}

#define NUM 5
int main()
{
  pthread_cond_init(&cond,nullptr);
  pthread_mutex_init(&lock,nullptr);
  pthread_t tid[NUM];
  for(int i=0;i<NUM;i++)
  {
    int* p=new int(i);
    if(i==0)
    {
      pthread_create(tid+i,nullptr,routine1,(void*)p);usleep(30000);//åˆ›å»ºå®Œç¡ä¸€ä¸‹ç¡®ä¿ä¸€å®šè·‘èµ·æ¥äº†  
    }
    else 
    {
      pthread_create(tid+i,nullptr,routine2,(void*)p);usleep(30000);//åˆ›å»ºå®Œç¡ä¸€ä¸‹è®©çº¿ç¨‹è·‘èµ·æ¥    
    }
  }
  for(int i=0;i<NUM;i++)
  {
    pthread_join(tid[i],nullptr);
  }
  pthread_mutex_destroy(&lock);
  pthread_cond_destroy(&cond);
  return 0;
}
```



![image-20220807190126126](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220807190126126.png)

å¯ä»¥çœ‹åˆ°å››ä¸ªçº¿ç¨‹æœ‰åºçš„è·‘èµ·æ¥äº†ã€‚

### ğŸ¥æ¡ä»¶å˜é‡ä½¿ç”¨è§„èŒƒ

ç­‰å¾…æ¡ä»¶ä»£ç 

```c
pthread_mutex_lock(&mutex);
while(æ¡ä»¶ä¸ºå‡)
    pthread_cond_wait(cond,&mutex);
ä¿®æ”¹æ¡ä»¶
pthread_mutex_unlock(&mutex);
```

ç»™æ¡ä»¶å‘é€ä¿¡å·ä»£ç 

```c
pthread_mutex_lock(&mutex);
è®¾ç½®æ¡ä»¶ä¸ºçœŸ
pthread_cond_signal(cond);    
pthread_mutex_unlock(&mutex);
```

ç®€å•æ¥è¯´å°±æ˜¯ï¼Œæ¡ä»¶ä¸æ»¡è¶³å°±å»ç­‰ï¼Œå¦ä¸€è¾¹è®¾ç½®æ¡ä»¶ä¸ºçœŸï¼Œå‘é€ä¸€ä¸ªä¿¡å·å”¤é†’ç­‰å¾…çš„çº¿ç¨‹ï¼Œçº¿ç¨‹å”¤é†’åæ‰§è¡Œè‡ªå·±çš„å·¥ä½œï¼Œæ‰§è¡Œå®Œä¹‹åå†å»ä¿®æ”¹æ¡ä»¶ã€‚

### ğŸ¥å°ç»“

æ¡ä»¶å˜é‡å¯ä»¥çœ‹åš0å’Œ1ï¼Œåªæœ‰æ»¡è¶³å’Œä¸æ»¡è¶³ä¸¤ç§çŠ¶æ€ï¼Œæ»¡è¶³å°±å¼€å§‹è·‘ï¼Œä¸æ»¡è¶³å°±ä¸è·‘ï¼Œå…¶ä¸­ç»å¸¸éœ€è¦ä¸€ä¸ªæ§åˆ¶è€…ã€‚

å”¤é†’çº¿ç¨‹å°±æ˜¯åœ¨æ‘‡é“ƒé“›ï¼Œå‘Šè¯‰ç­‰å¾…é˜Ÿåˆ—ç°åœ¨å¯ä»¥æ¥æ‹¿â€è‹¹æœâ€œäº†ï¼ŒåŒæ—¶æ’é˜Ÿæœ¬èº«å°±æ˜¯æœ‰åºçš„ï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯å¤šä¸ªçº¿ç¨‹æœ‰åºçš„æ¥æ‹¿â€œè‹¹æœâ€,å³æœ‰åºçš„è®¿é—®ä¸´ç•Œèµ„æºã€‚

> è¯´äº†è¿™ä¹ˆå¤šï¼Œå…¶å®ä¸å°±æ˜¯ç­‰å’Œå”¤é†’ï¼Œæ¡ä»¶æ»¡è¶³å°±å”¤é†’ï¼Œä¸æ»¡è¶³å°±ç­‰åˆ°æ¡ä»¶æ»¡è¶³ã€‚ç­‰å¾…æ˜¯æœ‰é˜Ÿåˆ—çš„ï¼Œä¿è¯äº†çº¿ç¨‹æœ‰åºæ‰§è¡Œï¼Œè¿›è€Œå°±å®ç°äº†åŒæ­¥ã€‚



# ğŸŒ²ä¿¡å·é‡

## ğŸŒ´æ¦‚å¿µ

- ä¿¡å·é‡æ˜¯ä»€ä¹ˆ?

æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè®¡æ•°å™¨,ç”¨æ¥æè¿°ä¸´ç•Œèµ„æºçš„æ•°ç›®.

> ä¸´ç•Œèµ„æºå…¶å®å¹¶ä¸æ˜¯ä¸€æ¬¡åªèƒ½ä¸€ä¸ªç°åœºè®¿é—®,å…¶å®å¯ä»¥æŠŠä¸´ç•Œèµ„æºåˆ†æˆå¤šä»½,è¿™æ ·æ¯ä¸ªçº¿ç¨‹è®¿é—®ä¸åŒä»½çš„èµ„æº,è‡ªç„¶ä¸ä¼šå‘ç”Ÿå†²çª.æ­¤æ—¶æˆ‘ä»¬æœ€æ‹…å¿ƒçš„æ˜¯å½“æˆ‘ä»¬è®¿é—®çº¿ç¨‹æ—¶æœ‰åˆ«çš„çº¿ç¨‹è¿›æ¥,è¿™æ ·é€ æˆçº¿ç¨‹å®‰å…¨é—®é¢˜,ç”±æ­¤å¼•å‡ºäº†ä¿¡å·é‡,ä¿¡å·é‡åˆ™æ˜¯ä¸€ç§å¯¹ä¸´ç•Œèµ„æºçš„é¢„å®šæœºåˆ¶.
>
> ä»»ä½•ä¸€ä¸ªçº¿ç¨‹,è¦å»è®¿é—®ä¸´ç•Œèµ„æºé‡Œçš„æŸä¸€ä¸ª,éƒ½è¦å…ˆç”³è¯·ä¿¡å·é‡,ç”³è¯·åˆ°äº†å†å»è®¿é—®ä¸´ç•Œèµ„æº,è®¿é—®å®Œäº†å†é‡Šæ”¾ä¿¡å·é‡.

- ä¿¡å·é‡çš„ä¸¤ç§æ“ä½œ

Pæ“ä½œå’ŒVæ“ä½œ.

Pæ“ä½œæ˜¯ç”³è¯·ä¿¡å·é‡,Væ“ä½œæ˜¯é‡Šæ”¾ä¿¡å·é‡.

å¤šä¸ªçº¿ç¨‹è¦ç”³è¯·ä¿¡å·é‡,è¯´æ˜ä¿¡å·é‡æœ¬èº«å°±æ˜¯ä¸€ç§ä¸´ç•Œèµ„æº,æ‰€ä»¥ä¿¡å·é‡åœ¨ä¿æŠ¤ä¸´ç•Œèµ„æºçš„åŒæ—¶å¾—å…ˆä¿è¯è‡ªå·±æ˜¯çº¿ç¨‹å®‰å…¨çš„,æ‰€ä»¥PVæ“ä½œæ˜¯åŸå­çš„.

> ä¼ªä»£ç :
>
> è®¾semä¸ºä¿¡å·é‡
>
> Pæ“ä½œ:
>
> ```cpp
> lock();
> if(sem>0)
> {
>  sem--;
> }
> else
> {
>  é‡Šæ”¾é”å¹¶æŒ‚èµ·;  
> }
> unlock()
> 
> ```
>
> Væ“ä½œ
>
> ```cpp
> lock();
> sem--
> unlock();
> ```
>
> è¿™åªæ˜¯ä¸€æ®µä¼ªä»£ç ,ä¿¡å·é‡åœ¨å†…æ ¸é‡Œçš„å®ç°è‚¯å®šæ¯”è¿™ä¸ªå¤æ‚,æ¯”å¦‚ä¿¡å·é‡é‡ŒåŒ…å«ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—

## ğŸŒ´æ¥å£

### ğŸŒµsem_init

åˆå§‹åŒ–ä¿¡å·é‡

```c
#include <semaphore.h>

int sem_init(sem_t *sem, int pshared, unsigned int value);

Link with -pthread.
```

- sem:è¡¨ç¤ºä¿¡å·é‡

- pshared:ä¼ å…¥0è¡¨ç¤ºçº¿ç¨‹é—´å…±äº«,ä¼ å…¥é0è¡¨ç¤ºè¿›ç¨‹é—´å…±äº«
- valueæ˜¯ä¿¡å·é‡çš„åˆå§‹å€¼

- è¿”å›å€¼:æˆåŠŸè¿”å›0,å¤±è´¥è¿”å›-1

### ğŸŒµsem_destroy

é”€æ¯ä¿¡å·é‡

```c
#include <semaphore.h>

int sem_destroy(sem_t *sem);

Link with -pthread.
```

- sem:ä¿¡å·é‡
- è¿”å›å€¼:æˆåŠŸè¿”å›0,å¤±è´¥è¿”å›-1

### ğŸŒµsem_wait

Pæ“ä½œ

```c
#include <semaphore.h>

int sem_wait(sem_t *sem);

Link with -pthread.
```

- sem:ä¿¡å·é‡
- è¿”å›å€¼:ç”³è¯·æˆåŠŸè¿”å›0,ä¿¡å·é‡çš„å€¼-1,ç”³è¯·å¤±è´¥è¿”å›-1,ä¿¡å·é‡çš„å€¼ä¸å˜

### ğŸŒµsem_post

Væ“ä½œ

```c
#include <semaphore.h>

int sem_post(sem_t *sem);

Link with -pthread.
```

- semä¿¡å·é‡
- è¿”å›å€¼:æˆåŠŸè¿”å›0,ä¿¡å·é‡çš„å€¼+1,å¤±è´¥è¿”å›-1,ä¿¡å·é‡çš„å€¼ä¸å˜

# ğŸŒ²ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹

## ğŸŒ´æ¦‚å¿µ

![image-20220911145116234](https://ccl-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220911145116234.png)

ä»å›¾ä¸­å¯ä»¥çœ‹å‡º**ä¸‰ç§å…³ç³»,ä¸¤ç§è§’è‰²,ä¸€ä¸ªäº¤æ˜“åœºæ‰€.**

- ä¸‰ç§å…³ç³»

  æ¶ˆè´¹è€…å’Œæ¶ˆè´¹è€…:ç«äº‰å…³ç³»,çº¿ç¨‹ä¸Šä½“ç°ä¸ºäº’æ–¥

  ç”Ÿäº§è€…å’Œç”Ÿäº§è€…:ç«äº‰å…³ç³»,çº¿ç¨‹ä¸Šä½“ç°ä¸ºäº’æ–¥

  æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…:äº’æ–¥ä¸åŒæ­¥å…³ç³»,ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éœ€è¦åœ¨åŒä¸€ä¸ªäº¤æ˜“åœºæ‰€äº¤æ˜“,å½“æœ‰å¤šä¸ªæ‰§è¡Œæµå°±å¾—ç«äº‰é”,æ‰€ä»¥ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´ä¹Ÿå­˜åœ¨ç«äº‰å…³ç³»,å…³äºä¸¤è€…çš„åŒæ­¥å…³ç³»:ä¸€ä¸ªç”Ÿäº§çš„å¿«,ä¸€ä¸ªæ¶ˆè´¹çš„æ…¢,å°±å¯èƒ½é€ æˆä¸€ä¸ªè§’è‰²çš„"é¥¥é¥¿",æ‰€ä»¥ä¸¤è€…ä¹‹é—´éœ€è¦åŒæ­¥.

- ä¸¤ç§è§’è‰²

  æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…,ä¸€èˆ¬æ˜¯çº¿ç¨‹æˆ–è€…è¿›ç¨‹

- ä¸€ä¸ªäº¤æ˜“åœºæ‰€

  å¸¸ç”¨çš„å¯ä»¥æ˜¯æ•°ç»„,é˜Ÿåˆ—ç­‰æ•°æ®ç»“æ„

> ä¸¾ä¸ªä¾‹å­,å­¦æ ¡é‡Œæœ‰è¶…å¸‚,æˆ‘ä»¬è¦ä¸€äº›æ—¥ç”¨å“æ˜¯å»è¶…å¸‚ä¹°è¿˜æ˜¯ç›´æ¥å»ç”Ÿäº§åœ°å·¥å‚ä¹°å‘¢,è‚¯å®šæ˜¯è¶…å¸‚,æ­¤æ—¶çš„è¶…å¸‚å°±æ˜¯ç”Ÿäº§åœºæ‰€,è€Œç”Ÿäº§è€…å°±æ˜¯å·¥å‚.
>
> - é‚£ä¸ºä»€ä¹ˆéœ€è¦è¶…å¸‚å‘¢?
>
>   è§£è€¦å’Œæ”¯æŒå¿™é—²ä¸å‡.
>
>   è§£è€¦:ç”Ÿäº§ç¯èŠ‚å’Œæ¶ˆè´¹ç¯èŠ‚è§£è€¦
>
>   æ”¯æŒå¿™é—²ä¸å‡,å·¥å‚ä¸€æ¬¡ç”Ÿäº§ä¸€å †,æ¶ˆè´¹è€…ä¸€ä¸ªä¸€ä¸ªçš„æ¶ˆè´¹,ç”Ÿäº§é€Ÿåº¦å’Œæ¶ˆè´¹é€Ÿåº¦ä¸ä¸€æ ·æ—¶è¶…å¸‚å°±èµ·åˆ°äº†åè°ƒçš„ä½œç”¨

## ğŸŒ´åŸºäºé˜»å¡é˜Ÿåˆ—çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹

![image-20220911151158910](https://ccl-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220911151158910.png)



- **é˜Ÿåˆ—ä¸ºç©ºæ—¶æ¶ˆè´¹è€…é˜»å¡,é˜Ÿåˆ—ä¸ºæ»¡æ—¶ç”Ÿäº§è€…é˜»å¡**
- ç”Ÿäº§è€…å°±æ˜¯å¾€é˜»å¡é˜Ÿåˆ—é‡Œå†™æ•°æ®,æ¶ˆè´¹è€…å°±æ˜¯å–æ•°æ®.å€ŸåŠ©æ¡ä»¶å˜é‡æ§åˆ¶è¯»å†™çš„ç­–ç•¥,æ¯”å¦‚å¯ä»¥æ˜¯å†™å…¥ä¸€ä¸ªæ•°æ®å°±é€šçŸ¥æ¶ˆè´¹è€…æ¥å–,è¿˜æ˜¯è¯´å†™æ»¡äº†æ•´ä¸ªé˜»å¡é˜Ÿåˆ—ç­‰æ¶ˆè´¹è€…æ¥å–.
- æ•°æ®æ»¡äº†è¿˜å¾€é‡Œå†™å°±ä¼šé€ æˆè¦†ç›–é—®é¢˜,å¯¼è‡´æ•°æ®çš„äºŒä¹‰æ€§ï¼Œé˜Ÿåˆ—ä¸ºç©ºè¿˜å»è¯» è¯»åˆ°çš„å°±æ˜¯æ—§æ•°æ®äº†ï¼Œä¹Ÿæ˜¯æœ‰é—®é¢˜çš„,æ‰€ä»¥æ•°æ®ä¸ºæ»¡æ—¶ç”Ÿäº§è€…é˜»å¡,æ•°æ®ç©ºäº†æ¶ˆè´¹è€…é˜»å¡

### ğŸ”¥ä»£ç 

**BlockQueue.hpp**

```cpp
#pragma once
#include <iostream>
#include <queue>
#include <pthread.h>
#include<stdlib.h>
#include <time.h>
using namespace std;

template<class T>
class BlockQueue
{
  public:

    BlockQueue(int cap)
      :_cap(cap)
    {
      pthread_mutex_init(&_lock,nullptr);
      pthread_cond_init(&_have_space,nullptr);
      pthread_cond_init(&_have_data,nullptr);
    }
    bool IsFull()
    {
      return _bq.size()==_cap;
    }
    bool IsEmpty()
    {
      return _bq.size()==0;
    }
    void Put(const T&in)//ç”Ÿäº§è€…
    {
        //p_lock å¤šç”Ÿäº§æ—¶åœ¨è¿™åŠ é”
      pthread_mutex_lock(&_lock);
      //æ»¡äº†å°±ä¸èƒ½ç”Ÿäº§äº†
      while(IsFull())//æ”¾åœ¨whileé‡Œé˜²æ­¢ä¼ªå”¤é†’
      //å¤šä¸ªçº¿ç¨‹åœ¨è¿™ç­‰å¾…,å¦‚æœç”¨ifåˆ¤æ–­æ¡ä»¶å’Œpthread_cond_broadcastå”¤é†’å¤šä¸ªçº¿ç¨‹,å¤šä¸ªçº¿ç¨‹ç«äº‰é”,å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ç«äº‰åˆ°äº†é”æ‰§è¡Œäº†å¯¹åº”çš„ä»»åŠ¡,æ­¤æ—¶æ¡ä»¶å˜é‡å˜äº†,å³åˆ«çš„çº¿ç¨‹ä¸åº”è¯¥è¢«å”¤é†’,ä½†æ­¤æ—¶åˆ«çš„çº¿ç¨‹å·²ç»é†’äº†ä¼šå»å¾€ä¸‹æ‰§è¡Œå¤„ç†æ•°æ®,æ‰€ä»¥ä¼šå‡ºé—®é¢˜.å¦‚æœç”¨whileçš„è¯,åˆ«çš„è¿™äº›å·²ç»é†’äº†çš„çº¿ç¨‹å†èµ°whileåˆ¤æ–­å°±å›åˆ°ç­‰å¾…çŠ¶æ€.è¯´äº†è¿™ä¹ˆå¤š,è®°ä½ç»“è®º:waitå’Œwhileè¿ç”¨,ç‰¹åˆ«æ˜¯çº¿ç¨‹æ± çš„æ—¶å€™æ³¨æ„è¿™å—
      {
        pthread_cond_wait(&_have_space,&_lock);
      }
      //èµ°åˆ°è¿™è‚¯å®šæœ‰ç©ºé—´äº†
      _bq.push(in);
      //æœ‰çš„è¯å°±ç›´æ¥å–Šäººæ¥æ¶ˆè´¹
      pthread_cond_signal(&_have_data);
      pthread_mutex_unlock(&_lock);
        //p_unlock å¤šç”Ÿäº§æ—¶åœ¨è¿™è§£é”
    }
    void Get(T* out)
    {
        //c_lock å¤šæ¶ˆè´¹æ—¶åœ¨è¿™ä¸Šé”
      pthread_mutex_lock(&_lock);
      //å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶å°±ä¸èƒ½æ¶ˆè´¹äº†
      while(IsEmpty())
      {
        pthread_cond_wait(&_have_data,&_lock);
      }
      //èµ°åˆ°è¿™è‚¯å®šä¸ä¸ºç©º
      *out=_bq.front();
      _bq.pop();
      pthread_cond_signal(&_have_space);
      pthread_mutex_unlock(&_lock);
        //c_unlock å¤šæ¶ˆè´¹æ—¶åœ¨è¿™è§£é”
    }
    ~BlockQueue()
    {
      pthread_mutex_destroy(&_lock);
      pthread_cond_destroy(&_have_data);
      pthread_cond_destroy(&_have_space);
    }
  private:
    int _cap;
    queue<T>_bq; 
    pthread_mutex_t _lock;   
    pthread_cond_t _have_space;
    pthread_cond_t _have_data;
};
```

**BlockQueue.cc**

```cpp
#include"BlockQueue.hpp"
#include<unistd.h>

class Task
{
public:
 int  operator()(int num)//ä»¿å‡½æ•°,æ¨¡æ‹Ÿåœ¨å¯¹æ•°æ®è¿›è¡Œå¤„ç†,è¿™é‡Œæ¨¡æ‹Ÿçš„æ˜¯1-numçš„å’Œ
 {
    return (1+num)*num/2;
 }

};

void* Producer(void* p)
{
  srand(time(0));
  BlockQueue<int>* bq=(BlockQueue<int>*)p;
  while(1)
  {
    int num=rand()%10;
    bq->Put(num);
    cout<<"producer: "<<num<<endl;
   sleep(1);//ç”Ÿäº§çš„æ…¢,æ¶ˆè´¹çš„å¿«,æ‰€ä»¥ç°è±¡æ˜¯ç”Ÿäº§ä¸€ä¸ªç«‹é©¬ä¼šè¢«æ¶ˆè´¹æ‰
  }
  
}

void* Consumer(void* c)
{
  BlockQueue<int>* bq=(BlockQueue<int>*)c;
  int out=0;
  Task task;
  while(1)
  {
    bq->Get(&out);
    cout<<"consumer: "<<task(out)<<endl;
    sleep(1);//æ¶ˆè´¹çš„æ…¢,ç”Ÿäº§è€…ç›´æ¥ç”Ÿäº§æ»¡äº†ç­‰æ¶ˆè´¹è€…æ¥æ‹¿
  }

}
int main()
{
  pthread_t producer;
  pthread_t consumer;
  BlockQueue<int>* bq=new  BlockQueue<int>(10);
  pthread_create(&producer,nullptr,Producer,bq);
  pthread_create(&consumer,nullptr,Consumer,bq);

  pthread_join( producer,nullptr);
  pthread_join( consumer,nullptr);

  delete bq;
  return 0;
}
```

#### ğŸ¥waitä¸whileè¿ç”¨çš„åŸå› 

[ä¸ºä»€ä¹ˆç”Ÿäº§è€…æ¶ˆè´¹è€…ä¸­æ¨¡å¼ä¸­è¦ç”¨whileä½œä¸´ç•Œåˆ¤æ–­ï¼Ÿ](https://blog.csdn.net/qq_37430539/article/details/100005522)

åŸå› :å¤šä¸ªçº¿ç¨‹è¢«å”¤é†’æŠ¢ä¸€æŠŠé”,å¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨è¿™æŠŠé”å¤–é¢ç­‰,å…¶ä»–çº¿ç¨‹é†’äº†åˆå»äº‰è¿™æŠŠé”,ä½†æ˜¯æ•°æ®å·²ç»è¢«ä¸Šä¸€ä¸ªçº¿ç¨‹è¯»èµ°äº†.

```cpp
void Put(const T&in)//ç”Ÿäº§è€…
{
    pthread_mutex_lock(&_lock);
    //æ»¡äº†å°±ä¸èƒ½ç”Ÿäº§äº†
    while(IsFull())//æ”¾åœ¨whileé‡Œé˜²æ­¢ä¼ªå”¤é†’
//å¤šä¸ªçº¿ç¨‹åœ¨è¿™ç­‰å¾…,å¦‚æœç”¨ifåˆ¤æ–­æ¡ä»¶å’Œpthread_cond_broadcastå”¤é†’å¤šä¸ªçº¿ç¨‹,å¤šä¸ªçº¿ç¨‹ç«äº‰é”,å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ç«äº‰åˆ°äº†é”æ‰§è¡Œäº†å¯¹åº”çš„ä»»åŠ¡,æ­¤æ—¶æ¡ä»¶å˜é‡å˜äº†,å³åˆ«çš„çº¿ç¨‹ä¸åº”è¯¥è¢«å”¤é†’,ä½†æ­¤æ—¶åˆ«çš„çº¿ç¨‹å·²ç»é†’äº†ä¼šå»å¾€ä¸‹æ‰§è¡Œå¤„ç†æ•°æ®,æ‰€ä»¥ä¼šå‡ºé—®é¢˜.å¦‚æœç”¨whileçš„è¯,åˆ«çš„è¿™äº›å·²ç»é†’äº†çš„çº¿ç¨‹å†èµ°whileåˆ¤æ–­å°±å›åˆ°ç­‰å¾…çŠ¶æ€.è¯´äº†è¿™ä¹ˆå¤š,è®°ä½ç»“è®º:waitå’Œwhileè¿ç”¨,ç‰¹åˆ«æ˜¯çº¿ç¨‹æ± çš„æ—¶å€™æ³¨æ„è¿™å—
    {
        pthread_cond_wait(&_have_space,&_lock);
    }
    //èµ°åˆ°è¿™è‚¯å®šæœ‰ç©ºé—´äº†
    _bq.push(in);
    //æœ‰çš„è¯å°±ç›´æ¥å–Šäººæ¥æ¶ˆè´¹
    pthread_cond_signal(&_have_data);

    pthread_mutex_unlock(&_lock);
}
```



### ğŸŒ¿è¿è¡Œæ•ˆæœ

ç”Ÿäº§è€…æ¯éš”ä¸€ç§’ç”Ÿäº§ä¸€ä¸ª,æ¶ˆè´¹è€…å°±æ¶ˆè´¹ä¸€ä¸ª

![ç”Ÿäº§è€…æ¶ˆè´¹è€…](https://ccl-1304888003.cos.ap-guangzhou.myqcloud.com/img/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85.gif)

ç”Ÿäº§è€…ä¸€ç›´ç”Ÿäº§,æ¶ˆè´¹è€…æ¯éš”1sæ¶ˆè´¹ä¸€ä¸ª

![ç”Ÿäº§è€…æ¶ˆè´¹è€…2](https://ccl-1304888003.cos.ap-guangzhou.myqcloud.com/img/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%852.gif)

æ¶ˆè´¹è€…ä¸€ç›´æ¶ˆè´¹,ç”Ÿäº§è€…æ¯éš”1sç”Ÿäº§ä¸€ä¸ª

![ç”Ÿäº§è€…æ¶ˆè´¹è€…3](https://ccl-1304888003.cos.ap-guangzhou.myqcloud.com/img/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%853.gif)

### ğŸ¥è¡¥å……

signalæ”¾åœ¨unlockå‰,é˜²æ­¢åˆšé‡Šæ”¾é”å°±åˆè¢«åˆ«çš„çº¿ç¨‹æ‹¿èµ°äº†å»åˆ¤æ–­æ¡ä»¶äº†,å¦‚æœäº‹åŠ¡çš„å¤„ç†ä¸å¤ŸåŠæ—¶å°±ä¼šé€ æˆçº¿ç¨‹å®‰å…¨é—®é¢˜

> [å½“Transactionalç¢°åˆ°é”ï¼Œæœ‰ä¸ªå¤§å‘ï¼Œè¦å°å¿ƒã€‚ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/6999476143699001352)
>
> è¿™å¼ æˆªå›¾æ˜¯ä¸Šé¢çš„åšå®¢é‡Œæˆªä¸‹æ¥çš„,ä¸‹æ¬¡è‡ªå·±å¤ä¹ çš„æ—¶å€™å¥½ç†è§£.
>
> ![image-20220913143317557](https://ccl-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220913143317557.png)



## ğŸŒ´åŸºäºç¯å½¢é˜Ÿåˆ—çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹

### é“ºå«

é‡‡ç”¨ç¯å½¢é˜Ÿåˆ—+ä¿¡å·é‡çš„æ–¹å¼æ¥å®ç°ä¸€ä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹.

![image-20220912202950029](https://ccl-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220912202950029.png)

> æ¯ä¸ªæ ¼å­éƒ½ç›¸å½“äºä¸€ä»½ä¸´ç•Œèµ„æº,åªè¦è®¿é—®çš„çš„æ ¼å­ä¸åŒå°±ä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜,æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨ä¿¡å·é‡çš„é¢„å®šæœºåˆ¶ä¿è¯å¤šä¸ªçº¿ç¨‹ä¸ä¼šæ“ä½œåŒä¸€ä¸ªæ ¼å­.



### ğŸ”¥ä»£ç 

**RingQueue.hpp**

```cpp
#pragma once 

#include<pthread.h>
#include<iostream>
#include<semaphore.h>
#include<unistd.h>
#include<stdlib.h>
#include<time.h>
#include<vector>
using namespace std;

template<class T>
class RingQueue
{
  public:
    RingQueue(int cap)
      :_cap(cap)
       ,_ring(_cap)
       ,c_index(0)
       ,p_index(0)
    {
      
      sem_init(&sem_space,0,_cap);
      sem_init(&sem_data,0,0);
    }
    void Put(const T& in)
    {
      //ç”Ÿäº§è€…
      //æ”¾é‡Œé¢æ”¾èµ„æºæ—¶å…ˆç”³è¯·ä¿¡å·é‡
      sem_wait(&sem_space);
      //lock å¤šç”Ÿäº§æ—¶åœ¨è¿™åŠ é”,æ­¤æ—¶åˆ«çš„çº¿ç¨‹è¿›æ¥ä¹Ÿå¯ä»¥å»ç”³è¯·ä¿¡å·é‡,è€Œä¸ç”¨è¿›åˆ°é”é‡Œé¢å†ç”³è¯·ä¿¡å·é‡
      _ring[p_index]=in;
      sem_post(&sem_data);//å‡å°‘ä¸´ç•ŒåŒºçš„ä»£ç 
      p_index++;
      p_index%=_cap;
      //unlock
    }
    void Get(T* out)
    {
      //æ¶ˆè´¹è€…
      sem_wait(&sem_data);
      //lock
      *out=_ring[c_index];
      sem_post(&sem_space);
      c_index++;
      c_index%=_cap;
      //unlock
    }
    ~RingQueue()
    {
      sem_destroy(&sem_space);
      sem_destroy(&sem_data);
    }
  private:

    int _cap;
    vector<T> _ring;
    sem_t sem_space;
    sem_t sem_data;
    size_t c_index;
    size_t p_index;
};
```

**main.cc**

```cpp
#include "RingQueue.hpp"

class Task
{
public:
  int operator()(int num)
  {
    int ans=0;
    for(int i=1;i<=num;i++)
    {
      ans+=i;
    }
    return ans;
  }
};

void* Producer(void* p)
{
  RingQueue<int>* rq=(RingQueue<int>*)p;
  while(1)
  {
    int num=rand()%10;
    rq->Put(num);
    cout<<"producer: "<<num<<endl;
    //sleep(1);//ç”Ÿäº§çš„æ…¢,æ¶ˆè´¹çš„å¿«,ç°è±¡åº”è¯¥æ˜¯æœ‰ä¸€ä¸ªå°±ä¼šè¢«ç›´æ¥æ¶ˆè´¹æ‰
  }
}

void* Consumer(void* c)
{
  RingQueue<int>* rq=(RingQueue<int>*)c;
  int out=0;
  Task t;
  while(1)
  {
    rq->Get(&out);
    int ans=t(out);
    cout<<"consumer: "<<ans<<endl;
    sleep(1);//ç”Ÿäº§çš„å¿«,æ¶ˆè´¹çš„æ…¢,åº”è¯¥æ˜¯ä¸€å¼€å§‹ç”Ÿäº§æ»¡äº†,åé¢æ¶ˆè´¹ä¸€ä¸ªå°±è¡¥å……ä¸€ä¸ª,é˜Ÿåˆ—ä¸€ç›´æ˜¯æ»¡çš„
  }
}

int main()
{
  pthread_t producer;
  pthread_t consumer;
  RingQueue<int> rq(10);
  pthread_create(&producer,nullptr,Producer,&rq);
  pthread_create(&consumer,nullptr,Consumer,&rq);

  pthread_join(producer,nullptr);
  pthread_join(consumer,nullptr);
  return 0;
}
```

### ğŸŒ¿è¿è¡Œæ•ˆæœ

æ¶ˆè´¹è€…æ¯éš”1sæ¶ˆè´¹ä¸€ä¸ª,ç”Ÿäº§è€…ä¸€ç›´åœ¨ç”Ÿäº§,ç°è±¡åº”è¯¥æ˜¯ç”Ÿäº§è€…ç›´æ¥æŠŠé˜Ÿåˆ—å¡æ»¡äº†,ç„¶åæ¶ˆè´¹è€…æ‹¿å®Œä¸€ä¸ªç”Ÿäº§è€…å°±è¡¥å……ä¸€ä¸ª.

![ç”Ÿäº§è€…æ¶ˆè´¹è€…4](https://ccl-1304888003.cos.ap-guangzhou.myqcloud.com/img/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%854.gif)

ç”Ÿäº§è€…æ¯éš”1sç”Ÿäº§ä¸€ä¸ª,æ¶ˆè´¹è€…ä¸€ç›´åœ¨æ¶ˆè´¹

![ç”Ÿäº§è€…æ¶ˆè´¹è€…5](https://ccl-1304888003.cos.ap-guangzhou.myqcloud.com/img/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%855.gif)

ç”Ÿäº§è€…æ¯éš”1sç”Ÿäº§,æ¶ˆè´¹è€…æ¯éš”1sæ¶ˆè´¹.

![ç”Ÿäº§è€…æ¶ˆè´¹è€…6](https://ccl-1304888003.cos.ap-guangzhou.myqcloud.com/img/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%856.gif)

### ğŸ¥è¡¥å……

è¿™é‡Œåªæ˜¯å•ç”Ÿäº§å•æ¶ˆè´¹,å¯ä»¥æ³¨æ„åˆ°è¿™é‡Œä¸é˜»å¡é˜Ÿåˆ—ä¸åŒçš„ç‚¹åœ¨äºè¿™é‡Œæ²¡æ‰‹åŠ¨åŠ é”.

å½“ç„¶å¤šç”Ÿäº§å¤šæ¶ˆè´¹çš„æ—¶å€™è‚¯å®šè¦åŠ é”,æ­¤å¤–è¦æ³¨æ„åŠ é”çš„ä½ç½®,æ¯”å¦‚é”æ˜¯åŠ åœ¨ç”³è¯·ä¿¡å·é‡çš„å‰é¢è¿˜æ˜¯åé¢,ç»“è®ºæ˜¯åŠ åœ¨åé¢,é‚£å¤šä¸ªçº¿ç¨‹å¯ä»¥åœ¨è¿›å…¥é”ä¹‹å‰å°±ç”³è¯·åˆ°ä¿¡å·é‡,ç›¸æ¯”äºè¿›å…¥é”æ‰èƒ½æ‹¿åˆ°ä¿¡å·é‡è‚¯å®šæ˜¯å‰è€…æ•ˆç‡æ›´é«˜.

# ğŸŒ²çº¿ç¨‹æ± 

## ğŸŒ´æ¦‚å¿µ

- æ± åŒ–æŠ€æœ¯

> [ã€é¡¹ç›®ã€‘å®ç°ä¸€ä¸ªminiçš„tcmallocï¼ˆé«˜å¹¶å‘å†…å­˜æ± ï¼‰](https://blog.csdn.net/m0_53005929/article/details/126691709?spm=1001.2014.3001.5501),é‡Œé¢è®²äº†æ± åŒ–æŠ€æœ¯

æ± åŒ–æŠ€æœ¯å¯ä»¥é¿å…é¢‘ç¹ç”³è¯·å¸¦æ¥çš„å¼€é”€,å¯ä»¥æé«˜æ€§èƒ½,å¥—åˆ°çº¿ç¨‹æ± è¿™é‡Œ,é‚£å°±æ˜¯åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ,æ± å­é‡Œæœ‰å¾ˆå¤šçº¿ç¨‹,ä¸€æ—¦æœ‰ä»»åŠ¡è¦æ‰§è¡Œ,ä¸å¿…ç”³è¯·å»åˆ›å»ºçº¿ç¨‹,è€Œæ˜¯ç›´æ¥ä»æ± å­é‡Œæ‹¿å‡ºçº¿ç¨‹å»å®Œæˆå¯¹åº”çš„ä»»åŠ¡,è¿™ä¸ªè¿‡ç¨‹å°±èŠ‚çœäº†åˆ›å»ºçº¿ç¨‹çš„å¼€é”€.

- çº¿ç¨‹æ± 

ä¸€æ¬¡é¢„å…ˆåˆ›å»ºä¸€å¤§æ‰¹çº¿ç¨‹,è®©è¿™äº›çº¿ç¨‹å¤„äºå¾…æœºçŠ¶æ€,ä¸€æ—¦æœ‰æ•°æ®æˆ–è€…ä»»åŠ¡å°±å¯ä»¥ç›´æ¥äº¤ç»™çº¿ç¨‹å¤„ç†

## ğŸ”¥ä»£ç å®ç°

å®ç°ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ± 

è¿™ä¸ªçº¿ç¨‹æ± é‡Œæœ‰numä¸ªçº¿ç¨‹,ä¸€æ—¦æœ‰ä»»åŠ¡å°±ç«‹é©¬ä»æ± å­é‡Œæ‹¿å‡ºçº¿ç¨‹å»å¤„ç†.æˆ‘è¿™é‡Œæ¨¡æ‹Ÿçš„ä»»åŠ¡ä¸ºæ•°å­—çš„åŠ å‡ä¹˜é™¤.

**ThreadPool.hpp**

```cpp
#pragma once 
#include<iostream>
#include<unistd.h>
#include<pthread.h>
#include<stdlib.h>
#include <time.h>
#include<queue>
#include "Task.hpp"
using namespace std;

template<class T>
class ThreadPool
{
public:
  ThreadPool()
  {
    pthread_cond_init(&_cond,nullptr);
    pthread_mutex_init(&_lock,nullptr);
  }
  void Lock()
  {
    pthread_mutex_lock(&_lock);
  }
  void UnLock()
  {
    pthread_mutex_unlock(&_lock);
  }
  void Wait()
  {
    pthread_cond_wait(&_cond,&_lock);
  }
  void WakeUp()
  {
    pthread_cond_signal(&_cond);
  }
  bool IsEmpty()
  {
    return _tq.size()==0;
  }
  void PopTask(T* out)
  {
    *out=_tq.front();
    _tq.pop();
  }
  void PushTask(const T& t)
  {
    Lock();
    _tq.push(t);
    WakeUp();
    UnLock();
    cout<<"åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—,å½“å‰ä»»åŠ¡æ•°:"<<_tq.size()<<",";
  }
  size_t Tqsize()
  {
    return _tq.size();
  }
  static void* Routine(void* args)//éstaticå‡½æ•°ä¼šæœ‰éšå«çš„å‚æ•°thisæŒ‡é’ˆ,æ‰€ä»¥ç”¨static
  {
    pthread_detach(pthread_self());
      //å› ä¸ºstaticå‡½æ•°åªèƒ½è°ƒç”¨staticæ–¹æ³•æˆ–æ•°æ®,ä½†æ˜¯æˆ‘ä»¬éœ€è¦è®¿é—®lockè¿™äº›æ‰€ä»¥éœ€è¦thisæŒ‡é’ˆ,æ­¤å¤–lockç›¸å…³æ“ä½œä¹Ÿè¦è¿›è¡Œå°è£…
      ThreadPool* threadPool=(ThreadPool*)args;
      //çœ‹é˜Ÿåˆ—é‡Œæœ‰æ²¡æœ‰å¾…å¤„ç†çš„ä»»åŠ¡,æ²¡æœ‰çš„è¯å°±è¿›è¡Œç­‰å¾…,æœ‰çš„è¯ç›´æ¥ç»™å¤„ç†äº†
      //_tqè¡¨ç¤ºä»»åŠ¡é˜Ÿåˆ—,ç”±äºä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„,å¾—åŠ é”
      while(true)
      {
      //è¿™é‡Œå¿…é¡»ä¸€ç›´åœ¨è·‘,ä¸ç„¶åˆ›å»ºçš„çº¿ç¨‹åªä¼šå¤„ç†ä¸€æ¬¡ä»»åŠ¡
          threadPool->Lock();
          while(threadPool->IsEmpty())//è¿™é‡Œä¸èƒ½ç”¨ifè¿›è¡Œåˆ¤æ–­
          {
            cout<<"é˜Ÿåˆ—ä¸ºç©ºå¼€å§‹ç­‰å¾…"<<endl;
            threadPool->Wait();
          }
          //èµ°åˆ°è¿™è¯´æ˜ä»»åŠ¡é˜Ÿåˆ—ä¸ä¸ºç©º
          T t;
          cout<<"å–å‡ºä»»åŠ¡"<<threadPool->Tqsize();
          threadPool->PopTask(&t);//æŠŠä»»åŠ¡å–å‡ºæ¥
          threadPool->UnLock();
          cout<<",å¼€å§‹å¤„ç†ä»»åŠ¡..."<<endl;
          t();//ä¸ç”¨åœ¨é”é‡Œé¢å¤„ç†äº†,ç›¸å½“äºçº¿ç¨‹çš„å±€éƒ¨å˜é‡,è¢«ä¸€ä¸ªçº¿ç¨‹ç‹¬æœ‰
 
      }
  }

  void ThreadPoolInit(int num)//è¿™é‡Œä¸æ˜¯æ„é€ å‡½æ•°,åˆ«å¿˜äº†æ‰‹åŠ¨å¯åŠ¨,æœ‰äººå¿˜äº†è°ƒè¯•äº†åŠå¤©æ˜¯è°æˆ‘ä¸è¯´,æ˜¯æˆ‘å•Šé‚£æ²¡äº‹äº†
  {
    for(int i=0;i<num;i++)
    {
      pthread_t tid;
      pthread_create(&tid,nullptr,Routine,(void*)this);
    }
  }
  ~ThreadPool()
  {
    pthread_cond_destroy(&_cond);
    pthread_mutex_destroy(&_lock);
  }


private:
  pthread_cond_t _cond;
  pthread_mutex_t _lock;
  queue<T> _tq;


};
```



**Task.hpp**

```cpp
#pragma once 

#include <iostream>
using namespace std;

class Task
{
public:
  Task()
  {}
  Task(int _a,int _b,char _op)
    :a(_a)
    ,b(_b)
    ,op(_op)
  {}
  ~Task()
  {}
  void operator()()//å¤„ç†å¯¹è±¡çš„æ•°æ®,ä¸è¦ä¼ å‚
  {
    int ans=0;
    switch(op)
    {
      case '+':
        ans=a+b;
        break;

      case '-':
        ans=a-b;
        break;
        
      case '*':
        ans=a*b;
        break;
      case '/':
        if(b==0)
        {
          cout<<"div 0"<<endl;
        }
        else 
        {
         ans=a/b;
        }
        break;
      case '%':
        if(b==0)
        {
          cout<<"mod 0"<<endl;
        }
        else 
        {
          ans=a%b;
        }
        break;
      default:
        cout<<"unknown op!"<<endl;
        break;
    }
    cout<<"thread["<<pthread_self()<<"]"<<": "<<a<<" "<<op<<" "<<b<<"="<<ans<<endl;
  }

private:
  int a;
  int b;
  char op;

};
```



**main.cc**

```cpp
#include"ThreadPool.hpp"
#include"Task.hpp"

int main()
{
  srand(time(nullptr));
  ThreadPool<Task>* threadPool=new ThreadPool<Task>();
  threadPool->ThreadPoolInit(10);
  sleep(1);
  string ops="+-*/%";
  while(true)
  {
    int x=rand()%50+1;
    int y=rand()%50+1;
    char op=ops[rand()%5];
    Task t(x,y,op);
 
    cout<<"æˆåŠŸåˆ›å»ºä»»åŠ¡,";
    threadPool->PushTask(t);
    
    sleep(1);
  }

  return 0;
}
```



# ğŸŒ²å¤šçº¿ç¨‹ä¼˜ç¼ºç‚¹å’Œçº¿ç¨‹çš„ä¼˜ç¼ºç‚¹

> è¿™éƒ½æ˜¯äº›æ¦‚å¿µäº†

- å¤šçº¿ç¨‹ä¼˜ç‚¹

çº¿ç¨‹é—´é€šä¿¡,æˆæœ¬ç‰¹åˆ«ä½

- å¤šçº¿ç¨‹ç¼ºç‚¹

å­˜åœ¨å¤§é‡çš„ä¸´ç•Œèµ„æº,æ‰€ä»¥è‚¯å®šéœ€è¦å„ç§äº’æ–¥å’ŒåŒæ­¥æœºåˆ¶æ¥ä¿æŠ¤ä¸´ç•Œèµ„æº.

- çº¿ç¨‹ä¼˜ç‚¹
  -  åˆ›å»ºçº¿ç¨‹ç›¸æ¯”åˆ›å»ºè¿›ç¨‹çš„ä»£ä»·å°
  - çº¿ç¨‹åˆ‡æ¢ä»£ä»·å°,å ç”¨èµ„æºå°,éƒ½æ˜¯ç›¸å½“äºè¿›ç¨‹æ¥è¯´
  - å……åˆ†åˆ©ç”¨å¤šå¤„ç†å™¨
  - ç­‰å¾…æ…¢é€ŸIOç»“æŸæ—¶æŒç»­å¯ä»¥å¤„ç†å…¶ä»–ä»»åŠ¡,æ­¤å¤–é€šè¿‡ä¸€äº›æ“ä½œä½¿å¾—IOæ“ä½œé‡å è®©çº¿ç¨‹å¯ä»¥åŒæ—¶ç­‰å¾…ä¸åŒçš„IOæ“ä½œ

- çº¿ç¨‹ç¼ºç‚¹

ä¸€ä¸ªçº¿ç¨‹å´©äº†,è¿›ç¨‹å°±å´©äº†,æ‰€ä»¥æˆ‘ä»¬ä¹Ÿè¯´çº¿ç¨‹é™ä½äº†ç¨‹åºçš„å¥å£®æ€§

# ğŸŒ²è¡¥å……

## ğŸŒ´è‡ªæ—‹é”(spinlock)

> [å¯¹æ¯”ä»‹ç»ï¼šäº’æ–¥é” vs è‡ªæ—‹é” ](https://zhuanlan.zhihu.com/p/297929103)

å½“æˆ‘ä»¬ä½¿ç”¨äº’æ–¥é”æ—¶,æ¯”å¦‚çº¿ç¨‹Aæ‹¿åˆ°äº†é”,çº¿ç¨‹Bå»å°è¯•åŠ é”å°±ä¼šå¤±è´¥,å†…æ ¸æŠŠè¿™ä¸ªçº¿ç¨‹æœ‰å°±ç»ªè½¬ä¸ºç¡çœ ,ç›´åˆ°åˆé€‚çš„æ—¶å€™å†æŠŠé”ç»™ä»–,å³å‘ç”Ÿäº†ä¸Šä¸‹æ–‡åˆ‡æ¢,å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢å°±ä¼šæœ‰å¼€é”€,å¦‚æœæ­¤æ—¶ä»£ç æ‰§è¡Œ1ns,çº¿ç¨‹åˆ‡æ¢4ns,é‚£æ˜¾ç„¶å¾—ä¸å¿å¤±.

æ‰€ä»¥ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸è®©è¿™ä¸ªçº¿ç¨‹ä¸€ç›´å»ç­‰å‘¢,è¿™å°±æ˜¯è‡ªæ—‹é”äº†,è‡ªæ—‹é”åŠ é”å¤±è´¥ä¼šä¸€ç›´ç­‰,ç›´åˆ°æˆåŠŸ.æ‰€ä»¥æˆ‘ä»¬å¦‚æœç›´åˆ°é”é‡Œé¢çš„ä»£ç è¿è¡Œæ—¶é—´å¾ˆçŸ­,å¯ä»¥é‡‡ç”¨è‡ªæ—‹é”æ¥æé«˜æ€§èƒ½.

åœ¨ç”¨æˆ·çœ‹æ¥çº¿ç¨‹æ²¡æœ‰ç”³è¯·åˆ°äº’æ–¥é”å’Œè‡ªæ—‹é”æ—¶,éƒ½åƒ"å¡ä½äº†"ä¸€æ ·

> è‡ªæ—‹é”çš„å®ç°æ€è·¯,ç”¨whileå¾ªç¯ä¸€ç›´å»æ£€æµ‹ä¸Šé”çš„çŠ¶æ€,åªè¦èƒ½åŠ é”ç«‹å³å°±åŠ é”,ä¸Šé¢é‚£ç¯‡åšå®¢é‡Œä¹Ÿè¯´äº†å¯ä»¥ç”¨CPUæŒ‡ä»¤çš„,æŒ‡ä»¤æ–¹é¢æˆ‘å°±ä¸å¤ªæ¸…æ¥šäº†.

## ğŸŒ´è¯»å†™è€…é—®é¢˜

- è¯»å†™è€…é—®é¢˜ä¹Ÿæœ‰ä¸‰ä¸ªå…³ç³»,ä¸¤ä¸ªè§’è‰²,ä¸€ä¸ªäº¤æ˜“åœºæ‰€,æœ‰ç‚¹åƒé»‘æ¿æŠ¥.

åœºæ™¯å¸¸è§äºè¯»è€…å¾ˆå¤š,å†™è€…å¾ˆå°‘.

ä¸‰ä¸ªå…³ç³»

| è§’è‰²       | å…³ç³»       | ç†ç”±                                         |
| :--------- | ---------- | -------------------------------------------- |
| è¯»è€…ä¸è¯»è€… | æ²¡æœ‰å…³ç³»   | å¤šä¸ªäººå¯ä»¥åŒæ—¶å»è¯»,ä¸ä¼šç«äº‰,å› ä¸ºä¸ä¼šå–èµ°æ•°æ® |
| å†™è€…ä¸å†™è€… | äº’æ–¥       | å†™æ•°æ®æ—¶æœ‰ç«äº‰å…³ç³»,æ¯”å¦‚ç«äº‰é”ä¹‹ç±»çš„          |
| è¯»è€…ä¸å†™è€… | äº’æ–¥ä¸åŒæ­¥ | ç«äº‰å…³ç³»,å¦‚æœä¸€è¾¹å†™ä¸€è¾¹è¯»å°±æœ‰åŒæ­¥å…³ç³»        |

ä¸¤ä¸ªè§’è‰²:å†™è€…å’Œè¯»è€…

ä¸€ä¸ªäº¤æ˜“åœºæ‰€:ä¸€æ®µç¼“å†²åŒº

> ç›¸å…³çš„æ¥å£æœ‰pthread_rwlock_rdlock,pthread_rwlock_wrlock,pthread_rwlock_unlock

- ä¼ªä»£ç 

```c
//ç®€åŒ–ç‰ˆ,åˆ©äºç†è§£,ä¸æ¶‰åŠç­‰å¾…é˜Ÿåˆ—ç­‰
int reader_cnt=0;
pthread_mutex_t lock;

//---------è¯»è€…çš„é”---------
lock();
++reader_cnt;
unlock();
è®¿é—®ä¸´ç•Œèµ„æº;//è¯»è€…ä¸è¯»è€…ä¹‹é—´æ²¡æœ‰å…³ç³»,æ‰€ä»¥è®¿é—®ä¸´ç•Œèµ„æºä¸å¿…åŠ é”
lock();
--reader_cnt;
unlock();

//---------å†™è€…çš„é”---------
start:
lock();
if(reader_cnt>0)//æœ‰è¯»è€…æ—¶ä¿è¯å†™è€…ä¸åœ¨è®¿é—®ä¸´ç•Œèµ„æº
{
    unlock();
    goto start;
}
è®¿é—®ä¸´ç•Œèµ„æº;//å†™æ—¶å¿…å®šæ²¡æœ‰è¯»è€…,ä¸”å†™çš„æ—¶å€™è‚¯å®šåœ¨é”çš„ä¿æŠ¤ä¸‹
unlock();
```

> ä¸ºäº†é¿å…è¯»è€…é¥¥é¥¿æˆ–è€…å†™è€…é¥¥é¥¿é—®é¢˜,æœ‰å¯¹åº”çš„ç­–ç•¥è§£å†³,å¦‚è¯»è€…ä¼˜å…ˆå’Œå†™è€…ä¼˜å…ˆç­‰.è¿™é‡Œä¸æ·±å…¥æ¢ç©¶

# ğŸŒ²æ€»ç»“

- çº¿ç¨‹,è½»é‡çº§è¿›ç¨‹,linuxç³»ç»Ÿå®ç°çº¿ç¨‹çš„æ–¹å¼å’Œå®ç°è¿›ç¨‹å·®ä¸å¤š(åŠ å‡ ä¸ªtask_struct)
- çº¿ç¨‹çš„åˆ›å»º,é”€æ¯,ç­‰å¾…,åˆ†ç¦»,å–æ¶ˆ,åŒæ­¥ç­‰,æ²¡æœ‰çº¿ç¨‹æ›¿æ¢
- æ¡ä»¶å˜é‡,ä¸»è¦å°±æ˜¯ä¸¤ä¸ªå‡½æ•°çš„ä½¿ç”¨,ä¸€ä¸ªæ˜¯pthread_cond_wait,ä¸€ä¸ªæ˜¯pthread_cond_signal,ä½¿ç”¨æ—¶è®°å¾—pthread_cond_waitå’Œwhileè¿ç”¨,æ¡ä»¶æ»¡è¶³å¼€å§‹pthread_cond_waitä½¿å¾—çº¿ç¨‹é™·å…¥ç­‰å¾…,æ¡ä»¶æ”¹å˜åç”¨pthread_cond_signalå‡½æ•°å”¤é†’çº¿ç¨‹,æœ¬è´¨ä¸Šæ˜¯ä¸ºäº†çº¿ç¨‹åŒæ­¥,å¯ä»¥åšåˆ°çº¿ç¨‹æœ‰åºçš„è¿è¡Œ,å®ä¾‹å°±æ˜¯çº¿ç¨‹æ± å’Œç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹
- ä¿¡å·é‡æœ¬è´¨å°±æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨,æè¿°äº†ä¸´ç•Œèµ„æºçš„æ•°ç›®,æ˜¯ä¸€ç§é¢„å®šæœºåˆ¶,ä¿¡å·é‡çš„æ“ä½œä¸»è¦æ˜¯PVæ“ä½œ,Pæ“ä½œç”³è¯·ä¿¡å·é‡,Væ“ä½œé‡Šæ”¾ä¿¡å·é‡
- ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹,ç†æ¸…æ¥šä¸‰ç§å…³ç³»,ä¸¤ä¸ªè§’è‰²å’Œä¸€ä¸ªäº¤æ˜“åœºæ‰€,å…·ä½“å®ç°å¯ä»¥é˜»å¡é˜Ÿåˆ—+æ¡ä»¶å˜é‡æˆ–è€…ç¯å½¢é˜Ÿåˆ—+ä¿¡å·é‡
- è‡ªæ—‹é”å’Œäº’æ–¥é”çš„åŒºåˆ«
- çº¿ç¨‹æ± å¯ä»¥åŠæ—¶çš„å¤„ç†ä»»åŠ¡,ä¸”çœå»äº†é¢‘ç¹åˆ›å»ºçº¿ç¨‹çš„å¼€é”€,å¦‚æœä¸æƒ³åˆ›å»ºå¤šä¸ªçº¿ç¨‹æ± ,å¯ä»¥ç»“åˆå•ä¾‹æ¨¡å¼,ç»“åˆå•ä¾‹æ¨¡å¼é‡Œçš„æ‡’æ±‰æ¨¡å¼è®°å¾—åŒæ£€æŸ¥.





















