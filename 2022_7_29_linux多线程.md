[toc]



从线程是什么，为什么要用和怎么用出发。下面探讨的都是linux下的线程

# 线程是什么

> [线程（计算机术语）_百度百科 (baidu.com)](https://baike.baidu.com/item/线程/103101)

线程是进程的一个执行分支，是在进程内部运行的一个执行流，是操作系统进行运算调度的最小单位。

在linux里我们也把线程成为轻量级进程（LWP，LightWeightProcess）,因为linux里其实没有真正的线程，线程是通过进程模拟出来的（在内核里都是一个个的task_struct)。

没学线程前我们说进程是操作系统最小的调度单位，因为那时我们写的代码都是单线程的，一个进程只有一个执行流，所以那么说也没错，准确一点就是线程是操作系统调度的最小单位。

单执行流

![image-20220804103802340](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220804103802340.png)

多执行流

![image-20220804104624107](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220804104624107.png)

通过上面两张图得出的一些结论，同时补充一些概念：

- 站在CPU的角度，进程与线程没有任何区别，它看到的都是task_struct,这也是为什么线程在linux里也叫轻量级进程，也说明linux下没有真正意义上的线程。简单来说，CPU对线程0感知。
- 线程之间是共用一个地址空间的，这说明比起进程之间的切换，线程的切换更加轻量级。因为进程切换可能要保存页表、地址空间的数据甚至缓存的数据等等，而线程之间切换时这些都不用动，自然切换的代价也比较小。
- 进程：线程=1：n，说明系统内有大量的线程，所以操作系统必定要把线程管理起来，说明如果一个系统支持真正的线程，比如windows，那必然是有一个结构（TCB）来描述这个线程的属性，并且将其组织起来，但是往往比较复杂，linux下虽然没有真正的线程，但是优点就是简单。
- linux下没有真正意义的线程，这就说明OS不可能在系统层面提供操作线程的接口，而是一些封装好给用户的轻量级接口。
- CPU调度的都是线程，即线程是CPU调度的最小单位
- 站在系统的角度，进程是承担系统资源的基本单位。因为第二个线程用的资源都是第一个线程申请好的。

- 线程在进程内部运行，这句话的意思是线程在进程地址空间内运行。
- 通过页表可以看到物理内存，也即真正的资源，同时说明只要划分页表我们就可以让线程看到进程的部分资源。
- 关于页表，页表不仅仅记录了虚拟地址与物理地址的映射，还有一些别的属性，如权限，是否命中等等，这说明页表的大小不是一个字节就能记录的。一般32位的机器物理内存是4G，说明有2^32^这么多个地址要映射，即页表要记录2^32^个映射关系，表示每一个映射关系需要的字节都大于1，说明页表整体大小大于4G，放不进内存，此时就引出了二级页表。负责这块的硬件就是MMU，具体的了解可以查询二级页表的相关资料。
- 线程数越多越好吗？并不是，建议与计算机的核数相当。线程过多会导致大部分时间花在调度上，而没有花在线程的执行上，有点买椟还珠的意思。                                                 

> 随笔记录:[一个程序被加载到内存，系统就创建了一个进程。请问这句话什么意思？为什么要先加载到内存？ (sogou.com)](https://wenwen.sogou.com/question/q710120053.htm)
>
> ![image-20220804112357220](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220804112357220.png)



# 线程的使用

线程的优缺点放在最后，直接贴在这里有点太抽象了。

相关接口的使用细节可以用man命令查询，下面直接贴基本用法。

## 相关概念补充

## pthread_create创建线程

创建一个新线程，成功返回0，失败返回一个错误码。

    #include <pthread.h>
    int pthread_create(pthread_t *thread, const pthread_attr_t *attr,void *(*start_routine) (void *),
    	 void *arg);
    Compile and link with -pthread.

> 关于pthread_t类型，typedef uintptr_t pthread_t;uintptr_t是unsigned long int。但是我们不应该这么做，因为pthread_t是一个不透明的类型，根据平台不同实现也不同，所以不应该用无符号长整形去定义它。这里我们只需知道线程ID的类型是pthread_t。判断两个线程ID相等也应该用相应的接口，而不是“==”，尽管线程ID打印出来是一个数字。

thread:输出型参数，返回创建的线程的id。

attr:设置线程的属性，attr为NULL表示默认属性

start_routine：函数指针，表示线程启动后要执行的函数。函数返回值和参数都为void*。

arg:传给线程启动函数的参数。

**编译时要加lpthread选项**，表示链接到pthread库

### 例子

创建一个新线程，主线程每隔1s打印一次，新线程每隔2s打印一次。

```cpp
#include <iostream>
#include <pthread.h>
#include<unistd.h>
using namespace std;

void* routine(void* args)//新线程执行的函数
{
  while(true)
  {
    cout<<(char*)args<<endl;
    sleep(2);
  }
  return nullptr;
}

int main()
{
  pthread_t tid;
  pthread_create(&tid,nullptr,routine,(void*)"thread 1");//创建新线程

  while(true)
  {
    cout<<"main thread is running"<<endl;
    sleep(1);
  }
  return 0;
}
```

![image-20220804161000876](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220804161000876.png)

## pthread_self()获取线程自身id

获取当前线程的id，函数调用总是成功，返回值为线程id。

```c
#include <pthread.h>

pthread_t pthread_self(void);
Compile and link with -pthread.
```

### 例子

每隔1s打印主线程和新线程的线程id

```cpp
#include <iostream>
#include <pthread.h>
#include<unistd.h>
using namespace std;

void* routine(void* args)
{
  while(true)
  {
    cout<<"thread1 id: "<<pthread_self()<<endl;
    sleep(1);
  }
  return nullptr;
}

int main()
{
  pthread_t tid;
  pthread_create(&tid,nullptr,routine,(void*)"thread 1");

  while(true)
  {
    //cout<<"main thread is running"<<endl;
    cout<<"main thread id: "<<pthread_self()<<endl;
    sleep(1);
  
  }
  return 0;
}
```

![image-20220804171207728](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220804171207728.png)

### ps-aL命令查看线程id

```shell
ps -aL  //这里查看的进程是上面的例子
```

可以看到进程id相同，因为两个线程属于同一个进程，主线程id和新线程id不同。

![image-20220804171503949](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220804171503949.png)

> 可以看到例子里打印的线程pthread_t和LWP显示的ID不同，直接给结论，LWP是系统唯一标识线程的ID，pthread_t本质是进程地址空间上的一个地址。





## pthread_exit()终止线程

## pthread_cancel()取消执行中的线程

## pthread_join()等待线程

## pthread_detach()分离线程













![image-20220729151321121](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729151321121.png)





![image-20220729151740976](C:/Users/ADMIN/AppData/Roaming/Typora/typora-user-images/image-20220729151740976.png)

![](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729151825406.png)





以前是单执行流 两个相等

![image-20220729152106991](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729152106991.png)





![image-20220729152556070](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729152556070.png)

一个线程出问题导致进程退出 这也是为什么说线程降低了程序的健壮性

![image-20220729153537161](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729153537161.png)



![image-20220729154050200](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729154050200.png)



![image-20220729155046825](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729155046825.png)



![image-20220729154750471](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729154750471.png)



![image-20220729155021524](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729155021524.png)

![image-20220729155622247](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729155622247.png)



![image-20220729161349626](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729161349626.png)



![image-20220729160803246](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729160803246.png)

![image-20220729161623417](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729161623417.png)



其他进程干掉主进程 其他线程一直跑导致进程一直处于Z状态 不被回收 

![image-20220729163136584](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729163136584.png)



![image-20220729163236006](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729163236006.png)



CPU不需要线程的概念   linux下线程这个概念是给用户的  因为用户需要多线程编程

因为不管进程还是线程啊 在linux内核里都是task_struct



linux下进程模拟实现的线程。



线程优点和缺点 斗与共享大量资源有关

进程为什么独立  因为有自己独立的地址空间 页表等。





![image-20220729212914901](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729212914901.png)



防止内存泄漏  （一直占着资源没释放，有点Z状态的意思

让main线程最后退出（main没了还有别的线程在跑不太合理

获得新线程的退出码（任务做的怎么样

  

![image-20220729213353372](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729213353372.png)

 





![image-20220730000452672](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730000452672.png)

![image-20220730000249758](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730000249758.png)





![image-20220730000327168](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730000327168.png)





返回值为void*的解释

![image-20220730194521066](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730194521066.png)



![image-20220730203122270](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730203122270.png)





返回一个结构体

![image-20220730203355531](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730203355531.png)

![image-20220730203415865](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730203415865.png)





![image-20220730204623368](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730204623368.png)



![image-20220730210436658](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730210436658.png)



  ![image-20220729125800585](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729125800585.png)   ![image-20220729130325143](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729130325143.png) ![image-20220729130313212](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729130313212.png) 合适：与计算机核数相当 不合适：线程过多 CPU过多的时间花在切换线程上（同步和调度开销  ![image-20220729150250511](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729150250511.png) ![image-20220729153722753](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729153722753.png)   ![image-20220729150804824](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729150804824.png)  ![image-20220729151309339](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729151309339.png) ![image-20220729151321121](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729151321121.png)   ![image-20220729151740976](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729151740976.png) ![](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729151825406.png)   以前是单执行流 两个相等 ![image-20220729152106991](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729152106991.png)   ![image-20220729152556070](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729152556070.png) 一个线程出问题导致进程退出 这也是为什么说线程降低了程序的健壮性 ![image-20220729153537161](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729153537161.png)  ![image-20220729154050200](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729154050200.png)  ![image-20220729155046825](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729155046825.png)  ![image-20220729154750471](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729154750471.png)  ![image-20220729155021524](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729155021524.png) ![image-20220729155622247](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729155622247.png)  ![image-20220729161349626](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729161349626.png)  ![image-20220729160803246](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729160803246.png) ![image-20220729161623417](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729161623417.png)  其他进程干掉主进程 其他线程一直跑导致进程一直处于Z状态 不被回收  ![image-20220729163136584](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729163136584.png)  ![image-20220729163236006](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729163236006.png)  CPU不需要线程的概念   linux下线程这个概念是给用户的  因为用户需要多线程编程 因为不管进程还是线程啊 在linux内核里都是task_struct  linux下进程模拟实现的线程。  线程优点和缺点 斗与共享大量资源有关 进程为什么独立  因为有自己独立的地址空间 页表等。   ![image-20220729212914901](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729212914901.png)  防止内存泄漏  （一直占着资源没释放，有点Z状态的意思 让main线程最后退出（main没了还有别的线程在跑不太合理 获得新线程的退出码（任务做的怎么样    ![image-20220729213353372](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729213353372.png)     ![image-20220730000452672](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730000452672.png) ![image-20220730000249758](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730000249758.png)   ![image-20220730000327168](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730000327168.png)   返回值为void*的解释 ![image-20220730194521066](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730194521066.png)  ![image-20220730203122270](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730203122270.png)   返回一个结构体 ![image-20220730203355531](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730203355531.png) ![image-20220730203415865](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730203415865.png)   ![image-20220730204623368](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730204623368.png)  ![image-20220730210436658](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730210436658.png)   





![image-20220730211214208](C:/Users/ADMIN/AppData/Roaming/Typora/typora-user-images/image-20220730211214208.png)![image-20220730211204292](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730211204292.png)









![image-20220730220614440](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730220614440.png)

![image-20220730220809931](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730220809931.png)

没有线程替换

线程共享地址空间 替换后是整个进程被替换





![image-20220730235208441](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220730235208441.png)

第二种就叫分离，分离的本质是让主线程不用再join新线程，让新线程退出的时候自动回收资源



分离的操作。



![image-20220731215711806](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731215711806.png)

![image-20220731220022911](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731220022911.png)

![image-20220731220616647](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731220616647.png)



一个进程出问题等于这个进程出问题。





 native pthread lib 原生线程库

![image-20220731221305068](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731221305068.png)

共享区被所有线程共享



![image-20220731222435978](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731222435978.png)

拿到用户级别的线程id 就可以在库里找到线程相关属性 包括线程的独立栈

![image-20220731222155303](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731222155303.png)





![image-20220731222204100](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731222204100.png)





![image-20220731222447767](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731222447767.png)



原生线程库与系统的关系

库中这个线程的起始地址，用户级线程一旦创建好 对应底层的一个LWP

为什么有线程库







读取全局变量  ![image-20220731224101403](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731224101403.png)

![image-20220731224427305](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731224427305.png)



![image-20220731224624217](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220731224624217.png)







访问临界资源的代码就是临界区





![image-20220801231639129](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220801231639129.png)



ticket--不是原子的

![image-20220801232332454](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220801232332454.png)





线程A的时间片到了 CPU寄存器里还有数据 这部分数据就称作上下文数据 也就是临时数据

寄存器是大家共享的 数据是私有的





这种现象的本质是ticket--不是原子性的。

![image-20220801233256743](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220801233256743.png)



![image-20220802011700392](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802011700392.png)









![image-20220802011753144](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802011753144.png)



多多陷入内核

![image-20220802011928141](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802011928141.png)



忘记解锁

![image-20220802095303177](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802095303177.png)



被锁保护起来的代码任何时候都只有一个人在跑

![image-20220802095641237](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802095641237.png)



锁的存在是为了保护临界资源

锁的本身就是一种临界资源  那谁来保护锁？保证lock和unlock是原子的



![image-20220802100406761](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802100406761.png)



![image-20220802100601053](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802100601053.png)

![image-20220802100825553](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802100825553.png)



![image-20220802101005495](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802101005495.png)









01两种状态

![image-20220802105538740](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802105538740.png)

1已经被拿到了x进程的上下文当中 别的进程拿不到了 别的进程再去xchgb只能拿到0  除非释放锁把1还回来

![image-20220802105412456](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802105412456.png)







申请对方的 又不释放自己的 死锁

请求你的锁 又不释放自己的锁

![image-20220802131151422](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802131151422.png)

 



![image-20220802132021577](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802132021577.png)







![image-20220802151119120](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802151119120.png)





![image-20220802152808083](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802152808083.png)





死锁段子

你需要工作经历才能找到工作

![image-20220802153826046](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802153826046.png)



![image-20220802153833166](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802153833166.png)



![image-20220802161622836](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802161622836.png)



![image-20220802164008355](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802164008355.png)



![image-20220802164417578](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802164417578.png)

![image-20220802164455191](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802164455191.png)



![image-20220802165003193](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802165003193.png)



把唤醒一个换成唤醒一批

![image-20220802171459690](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802171459690.png)

![image-20220802170715259](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802170715259.png)

![image-20220802172516656](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220802172516656.png)

![image-20220803100932364](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803100932364.png)

数据满了还往里写就会造成覆盖问题 导致数据的二义性，队列为空还去读 读到的就是旧数据了，也是有问题的



.hpp 把声明和实现写一起

![image-20220803102046542](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803102046542.png)









![image-20220803102651461](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803102651461.png)

![image-20220803102636867](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803102636867.png)



![image-20220803110314312](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803110314312.png)



![image-20220803110900351](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803110900351.png)



![image-20220803111017669](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803111017669.png)



![image-20220803112215648](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803112215648.png)

![](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803113256689.png)

最后

![image-20220803113741926](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803113741926.png)

![image-20220803113550478](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803113550478.png)





![image-20220803114246754](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803114246754.png)

![image-20220803114301228](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803114301228.png)

![image-20220803151307524](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803151307524.png)

![image-20220803151456451](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803151456451.png)



多生产多消费

![image-20220803152058253](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803152058253.png)



![image-20220803155725869](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803155725869.png)

![image-20220803160236873](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803160236873.png)



![image-20220803161351171](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803161351171.png)





![image-20220803161741634](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803161741634.png)

![image-20220803162129714](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803162129714.png)



![image-20220803163534309](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803163534309.png)





![image-20220803163645985](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803163645985.png)

![image-20220803163850072](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803163850072.png)

![image-20220803164437514](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803164437514.png)

![image-20220803164846479](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803164846479.png)



![image-20220803165046299](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803165046299.png)



![image-20220803165752752](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803165752752.png)



![image-20220803170504852](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803170504852.png)



![image-20220803170936705](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803170936705.png)



![image-20220803171134349](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803171134349.png)



![image-20220803215226751](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803215226751.png)



![image-20220803215439360](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803215439360.png)

 

![image-20220803215901652](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803215901652.png)





![image-20220803222742756](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803222742756.png)



 





![image-20220803223437730](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803223437730.png)

加锁 因为p_index++

维护生产者与生产者 消费者与消费者的关系

![image-20220803224058560](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803224058560.png)





![image-20220803232621964](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803232621964.png)



![image-20220803232747693](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220803232747693.png)





 ![image-20220804000624452](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220804000624452.png)



![image-20220804001228300](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220804001228300.png)



















































![image-20220729130325143](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729130325143.png)

![image-20220729130313212](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729130313212.png)

![image-20220729125800585](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220729125800585.png)































