

[toc]



# 进程通信引论

## 概念

进程通信是指在进程间传输数据(交换信息)。--百度百科

> 人与人之间的通信是什么？交换信息。进程之间的信息是什么？是数据！所以**进程通信可以理解为进程之间传递数据。**
>
> **IPC**(InterProcess Communicatio)是进程间通信的简称。

进程通信要做的事可以理解为让多个进程看到同一块资源。

## 目的

进程通信的目的

- 数据传输：一个进程发送数据给另一个进程，数据量在一个字节到几M字节之间
- 共享数据：多个进程共享同一块资源，做到这点需要内核提供同步和互斥机制。
- 通知事件：一个进程向另一个进程发消息，比如一个进程结束时应该通知其父进程
- 进程控制：一个进程完全控制另一个进程，如debug进程。

> 这些听起来都太抽象了，联系实际场景才能理解。

## 本质

进程通信的本质就是**让多个进程看到同一块资源**。

> 这块资源常指的是内存资源，在linux下一切皆文件，所以也可以理解成文件资源。
>
> 进程通信的方式也是围绕着这一句话展开的。

## 分类

System V和POSIX我理解为不同的标准。

![image-20220720154922782](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720154922782.png)

我们主要了解匿名管道、命名管道、共享内存和信号量，通信方式不同，自然通信策略也不同。

> [System v 和 Posix作用和区别（进程间通信IPC）_山农的博客-CSDN博客_system v](https://blog.csdn.net/return_cc/article/details/78417642)
>
> System V是Unix系统的某个版本。Posix是由IEEE和ISO开发的一套标准，两个都可以说是一种系统接口的协议。

# 管道

## 管道概念

管道是一种常见的进程通信工具。

Linux里的管道命令是'|'。

```shell
ls -l | grep *.txt
```

![image-20220720162349474](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720162349474.png)![image-20220720164405847](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720164405847.png)

## 为什么需要管道

我们为什么需要管道，或者说两个进程间能直接传递数据吗？因为进程间不能直接通信，每个进程都是独立的，进程有自己的地址空间，如果两个进程直接传递数据，会发生写时拷贝。所以此时我们需要一个媒介，也就是这里讲的管道。借助管道我们可以实现两个进程之间的单向通信。

> 所以管道的作用自然也就出来了，管道的作用就是让两个进程看到同一份资源,这个资源常常指的是内存资源，也可抽象为文件资源。

![image-20220720161823499](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720161823499.png)

![image-20220720161833247](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720161833247.png)

## 匿名管道

匿名管道用于有亲子关系的进程，常见于父子也可以用于兄弟等。

![image-20220720170746651](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720170746651.png)

- 管道实现形态上是文件，但是管道本身不占用磁盘或其他外部存储的空间--摘自知乎。

- 管道文件的内容在内存的缓冲区上，缓冲区的内容不会刷新到磁盘的文件上

  > 个人认为是没必要刷新到磁盘上，从内存读取的速度比从从磁盘上快的多，管道传输数据也是单向的，数据被接收的进程读取后没必要刷新到磁盘上。硬要刷新到磁盘上的话那没必要用管道...让这两个进程加载磁盘上的同一个文件不就行了。
  >
  > [大佬对于管道的一些理解](http://bbs.chinaunix.net/thread-314244-1-1.html)，从中摘录一段话：作为管道，一旦创建成功，应用除了传递数据外，能够做的只有删除操作了。

### 创建匿名管道

匿名管道用于两个有亲缘关系的进程之间的单向通信，比如父进程写子进程读。如果有多个进程需要通信，那就建立多个管道。

#### pipe函数

 int pipe(int pipefd[2]);

传入参数为一个数组，也是输出型参数，pipefd[0]放管道的读端文件描述符，pipefd[1]放管道的写端文件描述符

![image-20220720161833247](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720220833958.png)

pipe函数的作用

![image-20220720224446834](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720224446834.png)

pipe结合fork之后的图

![image-20220720225237600](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720225237600.png)

**父子进程通过关闭文件描述符来实现管道的单向通信**

对管道里面写入数据的操作，和对文件里写入数据的操作一样，印证了Linux下的一切皆文件。

管道是单向的，肯定是一个写一个读。所以建议写之前关闭读，读之前关闭写

> 既然是写之前要关闭读，读之前要关闭写，那一开始为什么还要打开读写呢，只打开读或者只打开写不就行了吗。因为父子进程拿到的文件打开方式是一样的，如果父进程只打开读那子进程也只能读，也就不能写了，我们有提到管道肯定是一个写一个读，所以父进程打开文件的方式肯定是读写（rw）。
>
> 为什么建议读之前关闭写，写之前关闭读？防止误操作。

下面的代码：父进程创建管道，父进程创建子进程，子进程在管道里每隔1s写入一次数据，父进程去读。



```c
#include <stdio.h>
#include<unistd.h>
#include<string.h>
#include <stdlib.h>
#include<sys/types.h>
#include <sys/wait.h>
int main()
{
  int pipe_fd[2]={0};
  int ret=pipe(pipe_fd);
  if(ret<0)
  {
    perror("pipe");
    return 1;
  }
  pid_t id=fork();
  if(id==0)
  {
    //child write
    close(pipe_fd[0]);//写之前关闭读
    int cnt=5;
    const char* msg="hello world!\n";
    while(cnt--)
    {
      write(pipe_fd[1],msg,strlen(msg));
      sleep(1);
    }
    close(pipe_fd[1]);
    exit(0);
  }
  else if(id>0)
  {
    //father read 
    close(pipe_fd[1]);//读之前关闭写
    char buffer[128];
    while(1)
    {
      ssize_t num=read(pipe_fd[0],buffer,127);//读到几个字节
      if(num>0)
      {
        buffer[num]='\0';
        printf("father get the msg from child:%s\n",buffer);
      }
      else if(num==0) 
      {
        printf("piple file close,child quit\n");
        break;
      }
      else 
      {
        perror("read");
      }
    }
    close(pipe_fd[0]);
    int status=0;
    if(waitpid(id,&status,0)>0)
    {
      printf("wait success!\n");
    }
  }
  else 
  {
    perror("fork");
  }
  return 0;
}
```

运行效果

![image-20220720232449493](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720232449493.png)

> 随笔记录：僵尸进程的产生是因为父进程没有 wait () 子进程。,所以如果我们自己写程序的话一定要在父进程中通过 wait () 来避免僵尸进程的产生，僵尸进程的产生会导致内存泄漏。子进程僵尸，父进程没回收，父进程退出后僵尸子进程会交给Init进程，Init进程会发现并回收这个僵尸进程，如果父进程一直在运行，子进程一直僵尸，内存就泄漏了。

### 管道读写的四种情况

写端进程一直写，读端进程不读。

写端进程不写，读端进程一直读。

写端进程写完后被关闭，读端进程还在读。

写端进程一直写，读端进程被关闭。

### 管道读写的特点

### 管道的大小



## 命名管道

### 创建命名管道



# System V IPC

## 共享内存

## 信号量















![image-20220718102645043](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220718102645043.png)

![image-20220718102714809](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220718102714809.png)

![image-20220718102810375](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220718102810375.png)

![image-20220718102919197](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220718102919197.png)

![image-20220719090944310](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719090944310.png)

![image-20220719092157147](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719092157147.png)

![image-20220719094009728](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719094009728.png)

![image-20220719095427535](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719095427535.png)

![image-20220719095144342](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719095144342.png)

![image-20220719101232509](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719101232509.png)

![image-20220719101624143](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719101624143.png)

![image-20220719103103990](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719103103990.png)

![image-20220719103655265](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719103655265.png)

![image-20220719104019065](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719104019065.png)

![image-20220719105253964](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719105253964.png)

![image-20220719110900570](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719110900570.png)

#### ![image-20220719151130052](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719151130052.png)

![image-20220719151054909](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719151054909.png)

![image-20220719152016120](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719152016120.png)



![image-20220719153042214](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719153042214.png)

shm share memory共享内存

![image-20220719153243922](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719153243922.png)



![image-20220719153622384](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719153622384.png)

![image-20220719154801571](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719154801571.png)

![image-20220719155220924](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719155220924.png)



![image-20220719155355755](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719155355755.png)

![image-20220719155814181](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719155814181.png)





![image-20220719155912371](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719155912371.png)



![image-20220719160830688](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719160830688.png)

![image-20220719161326855](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719161326855.png)



![image-20220719161623436](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719161623436.png)

![image-20220719161718563](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719161718563.png)



![image-20220719162316112](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719162316112.png)







![image-20220719162425953](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719162425953.png)





![image-20220719162554471](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719162554471.png)

![image-20220719162924649](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719162924649.png)

![image-20220719162939495](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719162939495.png)

![image-20220719163037580](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719163037580.png)

![image-20220719171304725](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719171304725.png)

![image-20220719171603106](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719171603106.png)

![image-20220719171811732](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719171811732.png)

![image-20220719235658639](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220719235658639.png)

![ ](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720000122172.png)

![image-20220720004215949](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720004215949.png)

![image-20220720004958182](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720004958182.png)

![image-20220720005232499](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720005232499.png)

![image-20220720005417419](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720005417419.png)





![image-20220720005559630](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720005559630.png)



![image-20220720005725504](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720005725504.png)







![image-20220720011752922](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720011752922.png)



![image-20220720011933017](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720011933017.png)



![image-20220720093052910](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720093052910.png)









![image-20220720095806242](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720095806242.png)



![image-20220720100109236](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720100109236.png)









![image-20220720100754883](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720100754883.png)



![image-20220720101535473](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720101535473.png)



![image-20220720101854875](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720101854875.png)

![image-20220720102558449](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720102558449.png)



![image-20220720103117877](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720103117877.png)

![image-20220720103906920](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720103906920.png)

![image-20220720111943063](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220720111943063.png)
